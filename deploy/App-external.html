<!DOCTYPE html>
<html>
<head>
    <title>Milestone Burnup with Projection</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function storeDataToString(data,columns){if(!data||!data[0]||!data[0].raw)return"No data to display: "+data;var actualColumns=columns||Object.keys(data[0].raw),keys=actualColumns.map(function(column){return column.split(".")});return data.reduce(function(result,row){return result.push(keys.map(function(key){var value=row.raw[key[0]];return"[object Object]"==""+value&&key[1]?value[key[1]]:value}).join("	")),result},[actualColumns.join("	")+"	"+data.length]).join("\n")}function resolvedPromise(value){return Deft.promise.Promise.when(value)}function rejectedPromise(error){var deferred=Ext.create("Deft.Deferred");return deferred.reject(error),deferred.promise}function promiseAll(array){return 0===array.length?[]:Deft.Promise.all(array)}function getRallyRecordType(record){return record&&record.getData()._type}function getRallyIdFromRef(ref,type){return+ref.slice(type.length+2)}function milestoneIcon(milestone){return"<span class='artifact-icon icon-milestone' style='transform:rotate(20deg);color: "+milestone.get("DisplayColor")+";'></span>"}function formatMilestone(milestone,context){return milestoneIcon(milestone)+"<a target='_blank' style='color:#274b6d' href='"+getMilestoneUrl(milestone,context)+"'>"+milestone.get("Name")+"</a>"}function getMilestoneUrl(milestone,context){return"https://rally1.rallydev.com/#/"+context.getProject().ObjectID+"d/detail"+milestone.getUri()}function formatProject(project,page){return page?"<a target='_blank' style='color:#274b6d' href='https://rally1.rallydev.com/#/"+project.get("ObjectID")+"d/"+page+"'>"+project.get("Name")+"</a>":project.get("Name")}function formatTeamFeature(teamFeature,context){return"<a target='_blank' style='color:#274b6d' href='"+getTeamFeatureUrl(teamFeature,context)+"'><strong style='font-size:0.95em'>"+teamFeature.get("FormattedID")+"</strong> "+teamFeature.get("Name")+"</a>"}function getTeamFeatureUrl(teamFeature,context){return"https://rally1.rallydev.com/#/"+context.getProject().ObjectID+"d/detail"+teamFeature.getUri()+"/userstories"}function hasOwnProperties(object,minNumber){minNumber=minNumber?minNumber:1;for(var property in object)if(object.hasOwnProperty(property)&&!--minNumber)return!0;return!1}function loggingSnapshotStoreExceptionHandler(proxy,response,operation){var messages=JSON.parse(response.responseText),log=function(message){console.log(message)};console.log("Problem when obtaining snapshot data:"),messages.Errors.forEach(log),messages.Warnings.forEach(log),console.log("proxy:",proxy,"response:",response,"operation:",operation)}function formatDate(date){return Rally.util.DateTime.format(date instanceof Date?date:new Date(date),"dMy")}function dateToIsoString(date){return date.toISOString().substring(0,10)}function chainedExpression(operator,expressions){var joined=expressions.filter(function(expression){return!!expression}).join(") "+operator+" (");return"(("+joined+"))"}function workItemQuery(data,condition){var itemIDs=data.filter(function(item){return"9999-01-01T00:00:00.000Z"===item.data._ValidTo}).filter(condition).map(function(item){return"ObjectID = "+item.data.ObjectID});return itemIDs.length>0?chainedExpression("OR",itemIDs):"* no such items *"}function isUserStory(item){return 0===item.data.FormattedID.indexOf("US")}function isDefect(item){return 0===item.data.FormattedID.indexOf("DE")}function isAccepted(item){return"Accepted"===item.data.ScheduleState||"Released-to-Production"===item.data.ScheduleState}function addBusinessDays(date,businessDays){var result=new Date(date);if(businessDays){for(var oldTimezoneOffset=result.getTimezoneOffset(),days=result.getDate(),d=result.getDay(),step=businessDays>0?1:-1,weekDayStep=businessDays>0?1:6;0!==businessDays;)days+=step,d=(d+weekDayStep)%7,0!==d&&6!==d&&(businessDays-=step);result.setDate(days);var offsetDiff=result.getTimezoneOffset()-oldTimezoneOffset;0!==offsetDiff&&result.setTime(result.getTime()-6e4*offsetDiff)}return result}function parseCapacityPlan(capacityPlanDefinition){if(!capacityPlanDefinition)return null;var capacityPlanString=(""+capacityPlanDefinition).trim();if(!capacityPlanString)return null;for(var parts=("1970-01-01 "+capacityPlanString).split(/\s+/),date,previousDate=new Date(-1),capacityPlan={dates:[],values:[]},dateIndex=0,capacityIndex=1;parts.length>capacityIndex;dateIndex+=2,capacityIndex+=2){if(date=new Date(parts[dateIndex]),!parts[dateIndex].match(/^\d\d\d\d-\d\d?-\d\d?$/)||isNaN(date.getTime()))throw"'"+parts[dateIndex]+"' found when a date was expected. The expected format is YYYY-MM-DD";if(previousDate>=date)throw"Invalid date: '"+dateToIsoString(date)+"'. It must be greater than '"+dateToIsoString(previousDate)+"'";previousDate=date;var capacity=parseFloat(parts[capacityIndex]);if(!parts[capacityIndex].match(/^[+\-]?(\d*(\.\d+)|\d+)$/)||isNaN(capacity))throw"'"+parts[capacityIndex]+"' found when a capacity value was expected. It must be a number";if(0>capacity)throw"'"+parts[capacityIndex]+"' found when a capacity value was expected. It must be a positive number";capacityPlan.dates.push(dateToIsoString(date)),capacityPlan.values.push(capacity)}if(capacityIndex===parts.length)throw"Unexpected value at the end: '"+parts[dateIndex]+"'. Capacity Plan definition must end with a capacity value preceeded by a date";return capacityPlan.dates.push(dateToIsoString(new Date(9999999999999))),capacityPlan}
                Ext.define("My.BurnUpCalculation",{TARGET_DATE:"Target Date",PROJECTED_DATE:"Projected Date",COMPLETED:"Completed",calculate:function(data,config){this.calcConfig={today:config.today||new Date,maxEndDate:config.maxEndDate,iteration:config.iteration,capacityPlan:config.capacityPlan,auxDates:config.auxDates,drawIterations:config.drawIterations,targetDate:config.targetDate,customStartDate:config.customStartDate,maxDaysAfterTargetDate:config.maxDaysAfterTargetDate,customTrendStartDate:config.customTrendStartDate,displayWidth:config.displayWidth};var tooltipStructure={Scope:{position:0},"Not Started":{position:1},"In Progress":{position:2},Completed:{position:3},Accepted:{position:4}},capacityProvider={capacity:function(index){return this.projectionCalculator.capacityPlan?this.projectionCalculator.stepWeight(index):null}};return this.capacityProvider=capacityProvider,this.chartConfig={xAxis:{plotLines:[]},yAxis:{},subtitle:{useHTML:!0},tooltip:{formatter:function(){var model={categories:[],get:function(series){return model.categories[tooltipStructure[series].position]},set:function(series,object){model.categories[tooltipStructure[series].position]=object}};this.points.forEach(function(p){model.set(p.series.name,{value:p.y,name:p.series.name,color:p.series.color})}),model.get("Scope")&&model.get("In Progress")&&model.get("Completed")&&model.get("Accepted")&&model.set("Not Started",{value:model.get("Scope").value-model.get("In Progress").value-model.get("Completed").value-model.get("Accepted").value,name:"Not Started",color:"#CFCFCF"}),model.categories.forEach(function(category){if(category.valueWholePart=Math.floor(category.value),category.valueDecimalPart=Math.floor(Math.round(10*(category.value-category.valueWholePart))),category.valueDecimalPart&&(model.isValueDecimalPart=!0),model.get("Scope")){var perMil=Math.round(1e3*(category.value/model.get("Scope").value)),percentWholePart=Math.floor(perMil/10);category.percent=percentWholePart+"."+Math.floor(Math.round(perMil-10*percentWholePart))+"%"}});var tooltip="<table style='border-spacing: 1ex 0; width: 100%'><caption>"+this.x+"</caption>";model.categories.forEach(function(category){if(category.value>0){var valueHTML=category.valueWholePart+(model.isValueDecimalPart?"."+category.valueDecimalPart:"");tooltip+="<tr><td style='color:"+category.color+"'>"+category.name+":</td>"+"<td style='font-weight: bold; text-align: right'>"+valueHTML+"</td>"+(category.percent?"<td style='text-align: right'>"+category.percent+"</td>":"")+"</tr>"}}),tooltip+="</table>";var capacity=capacityProvider.capacity(this.points[0].point.x);return null!==capacity&&(tooltip+="<div style='padding-top: 0.8em; text-align: center; font-size: 0.9em'>Planned capacity: "+capacity+"/day</div>"),tooltip},useHTML:!0,shared:!0}},this.adjustChartStart(data),this.stripFutureBars(data),this.addTrendLinesAndSubtitle(data),this.adjustDataAndChartConfig(data),this.chartConfig},adjustChartStart:function(data){var firstInProgressIndex=this.findDateIndex(data.categories,this.calcConfig.today,!1,data.categories.length);data.series.forEach(function(series){if("Scope"!==series.name)for(var i=0;series.data.length>i;i++)if(series.data[i]>0&&firstInProgressIndex>i){firstInProgressIndex=i;break}});var startIndex=this.calcConfig.customStartDate?this.findDateIndex(data.categories,this.calcConfig.customStartDate,!1,0):firstInProgressIndex;data.series.forEach(function(series){series.data=series.data.slice(startIndex)}),data.categories=data.categories.slice(startIndex)},stripFutureBars:function(data){var currentIndex=this.findDateIndex(data.categories,this.calcConfig.today,!1,data.categories.length)+1;data.series.forEach(function(series){if("Scope"!==series.name)for(var i=currentIndex;series.data.length>i;i++)series.data[i]=null})},addVerticalLine:function(label,index,config){if(-1!==index){for(var plotLines=this.chartConfig.xAxis.plotLines,i=0;plotLines.length>i;i++)plotLines[i].value===index&&(label=plotLines[i].label.text+" / "+label,plotLines.splice(i,1));plotLines.push(Ext.merge({label:{text:label,y:3,x:3,useHTML:!0},value:index,width:2,color:"#000",zIndex:5},config))}},addSeriesLine:function(data,name,series,config){series&&data.series.push(Ext.merge({name:name,data:series,type:"line",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1},config))},addSubtitleText:function(text){var subtitle=this.chartConfig.subtitle;subtitle.text=subtitle.text?subtitle.text+" &nbsp;&nbsp;&nbsp; "+text:text},addTrendLinesAndSubtitle:function(data){var config=this.calcConfig,acceptedData=this.getSeriesData(data,"Accepted"),plannedData=this.getSeriesData(data,"Scope"),dates=data.categories,todayIndex=this.findDateIndex(dates,config.today),targetDateIndex=this.findDateIndex(dates,this.calcConfig.targetDate),todayAcceptedPoints=acceptedData[todayIndex],todayPlannedPoints=plannedData[todayIndex],projectionStart=this.getTrendStart(dates,acceptedData),trendSeries,completedIndex,projectionCalculator=this.createProjectionCalculator({capacityPlan:this.calcConfig.capacityPlan,projectionStart:projectionStart,firstDate:dates[0]});if(this.capacityProvider.projectionCalculator=projectionCalculator,this.calcConfig.targetDate){var idealData=projectionCalculator.trendData(targetDateIndex,plannedData[targetDateIndex],targetDateIndex);this.addSeriesLine(data,"Ideal",idealData,{dashStyle:"Dot"}),this.addSubtitleText(this.TARGET_DATE+": "+formatDate(this.calcConfig.targetDate))}var trendControlIndex=todayIndex;if(todayAcceptedPoints===todayPlannedPoints&&todayPlannedPoints>0){for(var k=trendControlIndex-1;acceptedData[k]===todayPlannedPoints||null===acceptedData[k]&&plannedData[k]===todayPlannedPoints;)trendControlIndex--,k--;completedIndex=trendControlIndex}else{var lastIndex=dates.length-1,lastPlannedPoints=plannedData[lastIndex];if(acceptedData[lastIndex]===lastPlannedPoints&&lastPlannedPoints>0){completedIndex=lastIndex;for(var l=lastIndex-1;acceptedData[l]===lastPlannedPoints||null===acceptedData[l]&&plannedData[l]===lastPlannedPoints;)completedIndex--,l--}}var projectedEndIndex,projectedDateIndex=projectionCalculator.trendTargetIndex(trendControlIndex,todayAcceptedPoints,todayPlannedPoints);if(projectedDateIndex){for(var maxDaysAfterTargetDate=this.calcConfig.maxDaysAfterTargetDate||0,trendEndIndex=Math.min(projectedDateIndex,(-1===targetDateIndex?trendControlIndex:targetDateIndex)+maxDaysAfterTargetDate),j=Math.max(todayIndex,targetDateIndex,dates.length-1);trendEndIndex>j;j++)plannedData.push(todayPlannedPoints),dates.push(dateToIsoString(addBusinessDays(new Date(dates[dates.length-1]),1)));1/0!==projectionCalculator.trendFactor(trendControlIndex,todayAcceptedPoints,trendEndIndex,todayPlannedPoints)&&(trendSeries=projectionCalculator.trendData(trendControlIndex,todayAcceptedPoints,trendEndIndex,todayPlannedPoints),this.addSeriesLine(data,"Trend",trendSeries,{dashStyle:"Dash"}),trendEndIndex>=projectedDateIndex&&(projectedEndIndex=projectedDateIndex),this.projectedEndDate=addBusinessDays(new Date(dates[0]),projectedDateIndex),!completedIndex&&this.projectedEndDate&&this.addSubtitleText(this.PROJECTED_DATE+": "+formatDate(this.projectedEndDate)))}if(completedIndex){var spliceIndex=Math.max(completedIndex,targetDateIndex)+1,deleteCount=dates.length;dates.splice(spliceIndex,deleteCount),acceptedData.splice(spliceIndex,deleteCount),plannedData.splice(spliceIndex,deleteCount),this.getSeriesData(data,"In Progress").splice(spliceIndex,deleteCount),this.getSeriesData(data,"Completed").splice(spliceIndex,deleteCount),this.addSubtitleText(this.COMPLETED+": "+formatDate(dates[completedIndex]))}this.addPlotLines(dates,projectedEndIndex,completedIndex);var maxPlannedPoints=plannedData.reduce(function(e,max){return e>max?e:max},0),yMax=1.3*todayPlannedPoints;maxPlannedPoints>yMax&&(this.chartConfig.yAxis.max=yMax),config.drawIterations&&this.addIterationsBands(dates)},addPlotLines:function(dates,projectedEndIndex,completedIndex){var config=this.calcConfig;if(config.auxDates&&hasOwnProperties(config.auxDates,1))for(var auxDate in config.auxDates)config.auxDates.hasOwnProperty(auxDate)&&this.addVerticalLine(config.auxDates[auxDate],this.findDateIndex(dates,auxDate,!0),{width:1,label:{x:2}});this.addVerticalLine("Today",this.findDateIndex(dates,config.today,!0),{color:"#AAA",dashStyle:"ShortDash"}),this.addVerticalLine(this.TARGET_DATE,this.findDateIndex(dates,config.targetDate,!0)),completedIndex?this.addVerticalLine(this.COMPLETED,completedIndex,{color:"#774"}):projectedEndIndex&&this.addVerticalLine(this.PROJECTED_DATE,projectedEndIndex,{dashStyle:"ShortDash"})},addIterationsBands:function(dates){for(var config=this.calcConfig,iterationStartDate=config.iteration.get("StartDate"),iterationEndDate=config.iteration.get("EndDate"),iterationDuration=0,date=iterationStartDate;iterationEndDate>date;)date=addBusinessDays(date,1),iterationDuration++;for(var band=!0,startDate=iterationStartDate;dateToIsoString(startDate)>dates[0];)startDate=addBusinessDays(startDate,-iterationDuration),band=!band;do startDate=addBusinessDays(startDate,iterationDuration),band=!band;while(dateToIsoString(startDate)<dates[0]);var startIndex=this.findDateIndex(dates,startDate);if(-1!==startIndex){var color="#F8F9FD";this.chartConfig.xAxis.plotBands=[];var i=startIndex-(band?iterationDuration:0);do this.chartConfig.xAxis.plotBands.push({color:color,from:Math.max(0,i),to:i+iterationDuration}),i+=2*iterationDuration;while(dates.length>i)}},getTrendStart:function(dates,acceptedData){var index;if(this.calcConfig.customTrendStartDate)index=this.findDateIndex(dates,this.calcConfig.customTrendStartDate,!1,0);else for(index=0;acceptedData.length>index&&!(acceptedData[index]>0);index++);return{index:index,value:acceptedData[index]||0}},findDateIndex:function(dates,date,floating,defaultIndex){var searchedDateString=date instanceof Date?dateToIsoString(date):date;if(dates.length>0&&searchedDateString>=dates[0])for(var i=0;dates.length>i;i++){var dateString=dates[i];if(dateString>=searchedDateString)return dateString>searchedDateString?i-(floating?.5:1):i}return defaultIndex||0===defaultIndex?defaultIndex:-1},getSeriesData:function(data,name){for(var i=0;data.series.length>i;i++){var s=data.series[i];if(s.name===name)return s.data}return[]},adjustDataAndChartConfig:function(data){data.categories=data.categories.map(function(date){return formatDate(date)});var displayWidth=Math.max(Math.min(+this.calcConfig.displayWidth||100,500),10),threshold=data.categories.length*(100/displayWidth),step,lineWidth,groupPadding,markerEnabled;threshold>360?(groupPadding=0,lineWidth=3,step=30):threshold>240?(groupPadding=.05,lineWidth=3,step=20):threshold>120?(groupPadding=.1,lineWidth=3,step=10):(groupPadding=.15,markerEnabled=!0,lineWidth=3,step=5),Ext.merge(this.chartConfig,{xAxis:{labels:{step:step}},plotOptions:{line:{marker:{enabled:markerEnabled},lineWidth:lineWidth},column:{groupPadding:groupPadding}}})},createProjectionCalculator:function(config){return config.capacityPlan?Ext.create("My.FlexProjectionCalculator",config):Ext.create("My.FixedProjectionCalculator",config)}}),Ext.define("My.FixedProjectionCalculator",{constructor:function(config){this.callParent(arguments),this.startIndex=config.projectionStart.index,this.startValue=config.projectionStart.value},trendFactor:function(endIndex,endValue){return this.startIndex>=0&&endIndex>this.startIndex&&this.startValue!==endValue?this._trendFactor(endIndex,endValue):(console.log("Unable to calculate trend step for values: (startIndex="+this.startIndex+", startValue="+this.startValue+", endIndex="+endIndex+", endValue="+endValue+")"),null)},trendData:function(endIndex,endValue,indexLimit,valueLimit){var trendFactor=this.trendFactor(endIndex,endValue);if(trendFactor&&0!==indexLimit){var data=[],i;for(i=0;this.startIndex>i;i++)data[i]=null;data[i]=this.startValue,i++;for(var actualIndexLimit=indexLimit||1/0;actualIndexLimit>=i&&(!valueLimit||valueLimit>=data[i-1]);i++)data[i]=data[i-1]+trendFactor*this.stepWeight(i);return data}return null},trendTargetIndex:function(endIndex,endValue,targetValue){var trendFactor=this.trendFactor(endIndex,endValue);return trendFactor&&(endValue-this.startValue)*(targetValue-endValue)>=0?endIndex+Math.ceil((targetValue-endValue)/trendFactor):null},stepWeight:function(index){return 1},_trendFactor:function(endIndex,endValue){return(endValue-this.startValue)/(endIndex-this.startIndex)}}),Ext.define("My.FlexProjectionCalculator",{extend:"My.FixedProjectionCalculator",constructor:function(config){this.callParent(arguments),this.capacity=[],this.capacityPlan=config.capacityPlan,this.capacityPlanCursor=0,this.dateCursor=config.firstDate},stepWeight:function(index){if(this.capacity[index])return this.capacity[index];for(var i=this.capacity.length;index>=i;i++)this.dateCursor>=this.capacityPlan.dates[this.capacityPlanCursor+1]&&this.capacityPlanCursor++,this.capacity[i]=this.capacityPlan.values[this.capacityPlanCursor],this.dateCursor=dateToIsoString(addBusinessDays(this.dateCursor,1));return this.capacity[index]},_trendFactor:function(endIndex,endValue){for(var weightSum=0,i=this.startIndex+1;endIndex>=i;i++)weightSum+=this.stepWeight(i);return(endValue-this.startValue)/weightSum}});
                window.dev=window.dev||void 0,Ext.define("MilestoneBurnupWithProjection",Ext.merge({extend:"Rally.app.App",componentCls:"app",setContextTimebox:function(timeboxScope){this._timeboxFromScope=timeboxScope&&timeboxScope.getRecord()},getContextTimebox:function(){return this._timeboxFromScope||this.setContextTimebox(this.getContext().getTimeboxScope()),this._timeboxFromScope},getSettingsFields:function(){var milestones=this.getSetting("milestones"),defaultConfig={width:400,labelWidth:210,labelAlign:"right"},checkboxConfig={labelWidth:380},currentProjectText="-- Current Project --",contextTimebox=this.getContextTimebox(),settingsFields=[];return settingsFields.push({name:"milestones",label:"Milestone(s)",xtype:"rallymilestonecombobox",editable:!0,multiSelect:!0,allowNoEntry:!0,emptyText:"-- Choose --",hideLabel:!1,autoSelect:!1,disabled:"milestone"==getRallyRecordType(contextTimebox),forceSelection:"string"!=typeof milestones||0>milestones.indexOf(",")}),settingsFields.push({html:"<h3>Additional options</h3>",xtype:"label"}),settingsFields.push({name:"project",label:"Project",xtype:"rallyprojectcombobox",allowBlank:!0,allowClear:!0,clearText:currentProjectText,emptyText:currentProjectText,listeners:{ready:function(comp){var originalValidator=comp.validator;comp.validator=function(value){return currentProjectText==value&&(value="",this.setValue(value)),!value||originalValidator.call(this,value)}}},config:defaultConfig}),settingsFields.push({name:"teamFeatures",xtype:"textfield",label:"Take only these Team Features: (IDs)",config:defaultConfig}),settingsFields.push({name:"customStartDate",xtype:"rallydatefield",label:"Ignore data until:",config:defaultConfig}),settingsFields.push({name:"customTrendStartDate",xtype:"rallydatefield",label:"Start projection lines from:",config:defaultConfig}),settingsFields.push({name:"maxDaysAfterTargetDate",xtype:"rallynumberfield",label:"Max days to show after Target Date",config:Ext.merge(Ext.clone(defaultConfig),{minValue:0,maxValue:250})}),settingsFields.push({name:"capacityPlan",xtype:"textarea",label:"Model projection lines with a specific capacity plan (provide average daily capacity values separated by the dates when they change &ndash; <abbr title='To express that team capacity is 3 before September, in September&#013;it is going to be doubled and later it is to be 2.5, you would write:&#013;&#013;3 2018-09-01 6 2018-10-01 2.5'>example</abbr>)",height:55,config:defaultConfig}),settingsFields.push({name:"projectTargetPage",xtype:"textfield",label:"When clicking on a project name, open this page:",config:defaultConfig}),settingsFields.push({name:"markAuxDates",xtype:"rallycheckboxfield",label:"Mark additional key dates on the chart (such dates must be specified in the Milestone's Notes field &ndash; <abbr title='To express that your Code Complete date is on Dec 10&#013;and RC Build is planned on Jan 15, you would write:&#013;&#013;2018-12-10 Code Complete&#013;2019-01-15 RC Build'>example</abbr>)",config:checkboxConfig}),settingsFields.push({name:"drawIterations",xtype:"rallycheckboxfield",label:"Draw iteration boundaries on chart's background",config:checkboxConfig}),settingsFields.push({name:"displayWidth",xtype:"combobox",label:"Display width %, decrease it to fix chart look in a small display area",store:Ext.create("Ext.data.Store",{fields:["value"],data:[{value:100},{value:50},{value:30}]}),queryMode:"local",displayField:"value",valueField:"value",config:defaultConfig,validator:function(value){if(isNaN(value))return"Number expected";var MIN=20,MAX=200;return MIN>value||value>MAX?"Value out of allowed range ("+MIN+"-"+MAX+")":!0}}),settingsFields.push({name:"debug",xtype:"rallycheckboxfield",label:"Debug mode (prints diagnostic information in JavaScript console)",config:checkboxConfig}),settingsFields},config:{defaultSettings:{maxDaysAfterTargetDate:45,markAuxDates:!0,projectTargetPage:"iterationstatus",displayWidth:100,drawIterations:!0}},getMilestoneIds:function(){if("milestone"===getRallyRecordType(this.getContextTimebox()))return[this.getContextTimebox()];var milestones=this.getSetting("milestones");return milestones?milestones.split(","):[]},getProjectId:function(){var project=this.getSetting("project");return project?getRallyIdFromRef(project,"project"):this.getContext().getProject().ObjectID},getTeamFeatureIds:function(){var teamFeatures=this.getSetting("teamFeatures");return teamFeatures?(""+teamFeatures).split(/\s*[,;\s]\s*/).map(function(id){return id.match(/^\d+$/)?"TF"+id:id.toUpperCase()}):[]},setDataLoading:function(loading){this.setLoading(this.dataLoaded?!1:loading)},setDataLoaded:function(loaded){this.dataLoaded=loaded,this.setLoading(!1)},layout:"fit",launch:function(){this.getDataForChart().then({success:function(chartSetup){this.add(Ext.merge(this.createChart(),chartSetup))},failure:function(error){this.setDataLoaded();var lines=["Unable to fetch data."];error&&error.error&&error.error.errors?lines=lines.concat(error.error.errors):lines.push(error),this.add({itemId:"chart",xtype:"container",html:lines.join("<br/>"),componentCls:"center"})},scope:this})},onTimeboxScopeChange:function(timeboxScope){var timebox=timeboxScope.getRecord(),timeboxType=getRallyRecordType(timebox);if("milestone"===timeboxType){this.setContextTimebox(timeboxScope);var settings={milestones:[timebox.get("_ref")]};Rally.data.PreferenceManager.update({appID:this.getAppId(),settings:settings}),this.remove("chart"),this.setDataLoaded(!1),this.launch()}},listeners:{boxready:function(app){app.setDataLoading(!0)},ready:function(app){app.defineCalculator()}},defineCalculator:function(){function metric(label,values){return{as:label,f:"filteredSum",field:"PlanEstimate",filterField:"ScheduleState",filterValues:values,display:"column"}}Ext.define("My.MilestoneBurnUpCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",mixins:["My.BurnUpCalculation"],getMetrics:function(){return[metric("In Progress",["In-Progress"]),metric("Completed",["Completed"]),metric("Accepted",["Accepted","Released-to-Production"]),{as:"Scope",f:"sum",field:"PlanEstimate",display:"line"}]},runCalculation:function(snapshots,snapshotsToSubtract){var data=this.callParent(arguments);return this.chartConfig=this.calculate(data,this.calculationConfig),data}})},createChart:function(){var app=this;return Ext.create("Rally.ui.chart.Chart",{itemId:"chart",chartColors:["#B4F4D9","#9FDDA7","#6DBD44",app.scopeColor,"#000","#000"],chartConfig:{title:{text:"Milestone"},chart:{zoomType:"xy"},xAxis:{title:{text:"Date"},labels:{maxStaggerLines:1,step:5}},yAxis:{title:{text:"Points"},minRange:10,min:0},plotOptions:{line:{marker:{enabled:!1},lineWidth:4},column:{pointPadding:0,stacking:!0},area:{stacking:!0,marker:{enabled:!1}}}},listeners:{snapshotsAggregated:function(chart){Ext.merge(chart.chartConfig,chart.calculator.chartConfig)},storesLoaded:function(){app.setLoading(!1)}}})},getDataForChart:function(){var teamFeatureIds=this.getTeamFeatureIds();return promiseAll([0===this.getMilestoneIds().length?[]:Rally.data.ModelFactory.getModel({type:"Milestone"}).then({success:function(model){return promiseAll(this.getMilestoneIds().map(function(id){return model.load(id)}))},scope:this}),this.getProjectId()?Rally.data.ModelFactory.getModel({type:"Project"}).then({success:function(model){return model.load(this.getProjectId())},scope:this}):this.getProjectId(),0===teamFeatureIds.length?[]:Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/TeamFeature",filters:Rally.data.wsapi.Filter.fromQueryString(chainedExpression("OR",teamFeatureIds.map(function(id){return"FormattedID = "+id}))),scope:this}).load(),Ext.create("Rally.data.wsapi.Store",{model:"Iteration",fetch:["StartDate","EndDate"],filters:Rally.data.wsapi.Filter.fromQueryString("((StartDate <= today) AND (EndDate >= today))")}).load()]).then({success:function(contextItems){try{this.capacityPlan=parseCapacityPlan(this.getSetting("capacityPlan"))}catch(error){return rejectedPromise("The following problem found in the Capacity Plan definition: <strong>"+error+"</strong>. "+"Please correct the app settings:<pre>"+this.getSetting("capacityPlan")+"</pre>")}var milestones=contextItems[0];if(this.project=contextItems[1],this.ensureColorsForMilestones(milestones),0===milestones.length)return rejectedPromise("No milestone specified. Set milestone filter in your page settings or choose milestone in the app settings.");if(this.teamFeatures=contextItems[2],0===this.teamFeatures.length&&teamFeatureIds.length>0)return rejectedPromise("None of the Team Features specified in the app settings, ID: <strong>"+teamFeatureIds.join(", ")+"</strong>, "+"exist in this project. Please correct the app settings or change the project.");this.iteration=contextItems[3][0];var query=chainedExpression("OR",milestones.map(function(milestone){return"Milestones.ObjectID contains "+milestone.getId()})),filter=Rally.data.wsapi.Filter.fromQueryString(query),context={project:this.getProjectId()?"/project/"+this.getProjectId():null};return promiseAll(this.getArtifactTypes(teamFeatureIds).map(function(artifactType){return Ext.create("Rally.data.wsapi.Store",{model:artifactType,filters:filter,fetch:["ObjectID","Milestones","Parent","PortfolioItem"],context:context,autoLoad:!0,limit:1/0}).load()})).then({success:function(results){var artifactIds=[].concat.apply([],results).map(function(record){return+record.raw.ObjectID});return this.getConfigForChart(artifactIds,milestones,this.teamFeatures)},scope:this})},scope:this})},getArtifactTypes:function(){var result=["HierarchicalRequirement"];return 0===this.getTeamFeatureIds().length&&result.push("PortfolioItem/TeamFeature","Defect"),result},getConfigForChart:function(artifactIds,milestones,teamFeatures){var teamFeatureIds=teamFeatures.map(function(teamFeature){return+teamFeature.get("ObjectID")}),query={_ProjectHierarchy:this.projectId,_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},_ItemHierarchy:{$in:artifactIds},Children:null};teamFeatureIds.length>0&&(query.ObjectID={$in:artifactIds},query._ItemHierarchy={$in:teamFeatureIds});var fetchFields=["_ValidFrom","_ValidTo","ObjectID","FormattedID","PlanEstimate","ScheduleState"],debug=this.getSetting("debug"),storeConfig={listeners:{load:function(store,data,success){debug&&(console.debug("[DEBUG] Data snapshots for chart START:"),console.debug(storeDataToString(data,fetchFields)),console.debug("[DEBUG] Query for list of all stories:"),console.debug(workItemQuery(data,function(item){return isUserStory(item)})),console.debug("[DEBUG] Query for list of all defects:"),console.debug(workItemQuery(data,function(item){return isDefect(item)})),console.debug("[DEBUG] Query for list of not accepted stories:"),console.debug(workItemQuery(data,function(item){return isUserStory(item)&&!isAccepted(item)})),console.debug("[DEBUG] Query for list of not accepted defects:"),console.debug(workItemQuery(data,function(item){return isDefect(item)&&!isAccepted(item)})))}},find:query,fetch:fetchFields,hydrate:["ScheduleState"],compress:!0,sort:{_ValidFrom:1},limit:1/0,removeUnauthorizedSnapshots:!0,useHttpPost:!0},today=new Date,targetDate=this.getTargetDate(milestones),maxDaysAfterTargetDate=this.getSetting("maxDaysAfterTargetDate"),endDate=targetDate;if(targetDate){if(today>targetDate){var maxEndDate=addBusinessDays(targetDate,maxDaysAfterTargetDate);endDate=today>maxEndDate?maxEndDate:today}}else endDate=today;return{calculatorType:"My.MilestoneBurnUpCalculator",calculatorConfig:{endDate:endDate,calculationConfig:{maxEndDate:endDate,targetDate:targetDate,iteration:this.iteration,capacityPlan:this.capacityPlan,auxDates:this.getAuxDates(milestones),drawIterations:this.getSetting("drawIterations"),customStartDate:this.getSetting("customStartDate"),customTrendStartDate:this.getSetting("customTrendStartDate"),maxDaysAfterTargetDate:maxDaysAfterTargetDate,displayWidth:this.getSetting("displayWidth")}},storeType:"Rally.data.lookback.SnapshotStore",storeConfig:storeConfig,exceptionHandler:loggingSnapshotStoreExceptionHandler,queryErrorMessage:"No work items found for <strong>"+this.getChartTitle(milestones,teamFeatures)+"</strong>.",chartConfig:{title:{text:this.getChartTitle(milestones,teamFeatures),useHTML:!0}}}},ensureColorsForMilestones:function(milestones){milestones&&milestones.forEach(function(milestone){milestone.get("DisplayColor")||milestone.set("DisplayColor","#888888")})},getTargetDate:function(milestones){var app=this,latestMilestoneDate=null;return milestones.forEach(function(milestone){var date=milestone.get("TargetDate");(!latestMilestoneDate||date&&date>latestMilestoneDate)&&(latestMilestoneDate=date,app.scopeColor=milestone.get("DisplayColor"))}),app.scopeColor||(app.scopeColor="#D42"),latestMilestoneDate},getAuxDates:function(milestones){var result={},app=this;return milestones.forEach(function(milestone){app.getSetting("markAuxDates")&&milestone.get("Notes").split(/<\/?[^>]+>/g).map(function(html){return html.trim().match(/^(\d\d\d\d-\d\d?-\d\d?)\W+(\w.*)$/)}).forEach(function(matches){matches&&!isNaN(Date.parse(matches[1]))&&(result[matches[1]]=20>=matches[2].length?matches[2]:matches[2].substring(0,20).trim()+"...")}),milestones.length>1&&milestone.get("TargetDate")&&(result[dateToIsoString(milestone.get("TargetDate"))]=milestoneIcon(milestone)+milestone.get("Name"))}),result},getChartTitle:function(milestones,teamFeatures){var context=this.getContext(),title=milestones.map(function(milestone){return formatMilestone(milestone,context)}).join(", ");return teamFeatures&&teamFeatures.length>0&&(title+=": "+teamFeatures.map(function(teamFeature){return formatTeamFeature(teamFeature,context)}).join(", ")),title+" &mdash; "+formatProject(this.project,this.getSetting("projectTargetPage"))}},dev?dev.app:null));

            Rally.launchApp('MilestoneBurnupWithProjection', {
                name:"Milestone Burnup with Projection",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .center{text-align:center}
    </style>
</head>
<body>
</body>
</html>
