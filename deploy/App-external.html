<!DOCTYPE html>
<html>
<head>
    <title>Milestone Burnup with Projection</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function resolvedPromise(value){return Deft.promise.Promise.when(value)}function rejectedPromise(error){var deferred=Ext.create("Deft.Deferred");return deferred.reject(error),deferred.promise}function loggingSnapshotStoreExceptionHandler(proxy,response,operation){var messages=JSON.parse(response.responseText),log=function(message){console.log(message)};console.log("Problem when obtaining snapshot data:"),messages.Errors.forEach(log),messages.Warnings.forEach(log),console.log("proxy =",window.proxy=proxy),console.log("response =",window.response=response),console.log("operation =",window.operation=operation)}function formatDate(date){return Rally.util.DateTime.format(date instanceof Date?date:new Date(date),"dMy")}function dateToIsoString(date){return date.toISOString().substring(0,10)}(function(){window.dev=window.dev||void 0,window.debug=window.debug||void 0;var originalDebug=console.debug;console.debug=function(){window.debug&&originalDebug.apply(this,arguments)}})();
                Ext.define("MilestoneBurnup",Ext.merge({extend:"Rally.app.App",componentCls:"app",getSettingsFields:function(){return[{name:"milestone",xtype:"mymilestonecombobox"}]},getMilestoneId:function(){return this.getSetting("milestone")},getProjectId:function(){return this.getContext().getProject().ObjectID},launch:function(){Ext.define("MyMilestoneBomboBox",{xtype:"rallymilestonecombobox",extend:"Rally.ui.combobox.MilestoneComboBox",alias:"widget.mymilestonecombobox",editable:!1,noEntryText:"-- choose a milestone --",allowNoEntry:!0}),this.getDataForChart().then({success:function(chartSetup){this.add(Ext.merge(this.createChart(),chartSetup))},failure:function(error){console.error("Unable to fetch chart data: ",error)},scope:this})},burnupCalculator:Ext.define("My.MilestoneBurnUpCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",getMetrics:function(){return[{field:"PlanEstimate",as:"In Progress",f:"filteredSum",filterField:"ScheduleState",filterValues:["In-Progress"],display:"column"},{field:"PlanEstimate",as:"Completed",f:"filteredSum",filterField:"ScheduleState",filterValues:["Completed"],display:"column"},{field:"PlanEstimate",as:"Accepted",f:"filteredSum",filterField:"ScheduleState",filterValues:["Accepted","Released"],display:"column"},{field:"PlanEstimate",as:"Planned",f:"sum",display:"line"}]},runCalculation:function(snapshots,snapshotsToSubtract){var data=this.callParent(arguments);return this.postProcessCalculation(data),data},postProcessCalculation:function(data){this.chartConfig={},this.stripFutureBars(data),this.addPlotLines(data),this.addProjection(data),this.addSubtitle()},today:new Date,stripFutureBars:function(data){var currentIndex=this.findDateIndex(data,this.today)+1;data.series.forEach(function(series){if("Planned"!=series.name)for(var i=currentIndex;series.data.length>i;i++)series.data[i]=null})},addPlotLines:function(data){this.chartConfig.xAxis=this.chartConfig.xAxis||{},this.chartConfig.xAxis.plotLines=[{value:this.findDateIndex(data,this.endDate),color:"#000",width:2,label:{text:"planned end"}},{value:this.findDateIndex(data,this.today,!0),color:"#AAA",width:2,label:{text:"today"},dashStyle:"ShortDash"}]},addProjection:function(data){var currentIndex=this.findDateIndex(data,this.today),actualStartIndex=currentIndex;data.series.forEach(function(series){if("Planned"!=series.name)for(var i=0;series.data.length>i;i++)series.data[i]>0&&actualStartIndex>i&&(actualStartIndex=i)});var currentAccepted=this.getSeries(data,"Accepted")[currentIndex];if(actualStartIndex>=0&&currentAccepted>0&&currentIndex>actualStartIndex){var projectionStep=currentAccepted/(currentIndex-actualStartIndex),projection=data.categories.reduce(function(projection,value,index){return actualStartIndex>=index?projection.push(index==actualStartIndex?0:null):projection.push((projection[index-1]||0)+projectionStep),projection},[]);data.series.push({name:"Projection",data:projection,type:"line",dashStyle:"Dash",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1});var currentPlanned=this.getSeries(data,"Planned")[currentIndex],daysRemaining=(currentPlanned-currentAccepted)/projectionStep;this.projectedEndDate=Rally.util.DateTime.add(this.today,"day",daysRemaining)}},addSubtitle:function(){var parts=[];this.endDate&&parts.push("Planned End: "+formatDate(this.endDate)),this.projectedEndDate&&parts.push("Projected End: "+formatDate(this.projectedEndDate)),this.chartConfig.subtitle={text:parts.join(" &nbsp;&nbsp;&nbsp; "),useHTML:!0}},findDateIndex:function(data,date,floating){for(var searchedDateString=date instanceof Date?dateToIsoString(date):date,i=0;data.categories.length>i;i++){var dateString=data.categories[i];if(dateString>=searchedDateString)return dateString>searchedDateString?i-(floating?.5:1):i}return-1},getSeries:function(data,name){var series=data.series.find(function(aSeries){return aSeries.name==name});return series?series.data:[]}}),createChart:function(){return Ext.create("Rally.ui.chart.Chart",{chartColors:["#AEC","#8FCD88","#5EAC00","#005EB8","#000"],chartConfig:{title:{text:"Milestone"},chart:{zoomType:"xy"},xAxis:{title:{text:"Date"},labels:{maxStaggerLines:1,step:5,formatter:function(){return formatDate(this.value)}}},yAxis:{title:{text:"Points"}},plotOptions:{line:{marker:{enabled:!0}},column:{stacking:!0},area:{stacking:!0,marker:{enabled:!1}}}},listeners:{snapshotsAggregated:function(chart){Ext.merge(chart.chartConfig,chart.calculator.chartConfig)}}})},getDataForChart:function(){return Deft.Promise.all([Rally.data.ModelFactory.getModel({type:"Milestone"}),this.getMilestoneId()]).then({success:function(modelAndId){var model=modelAndId[0],id=modelAndId[1];return id?model.load(id):rejectedPromise("No milestone set")},scope:this}).then({success:function(milestone){var context={project:this.getProjectId()?"/project/"+this.getProjectId():null},filter=Rally.data.wsapi.Filter.fromQueryString("(Milestones.ObjectID contains "+milestone.getId()+")");return Deft.Promise.all(["Defect","HierarchicalRequirement","PortfolioItem/TeamFeature"].map(function(artifactType){var deft=Ext.create("Rally.data.wsapi.Store",{model:artifactType,filters:filter,fetch:["ObjectID"],context:context,autoLoad:!0}).load();return deft})).then({success:function(results){var artifactIds=results.reduce(function(result,records){return result.concat(records.map(function(record){return+record.raw.ObjectID}))},[]);return this.getConfigForChart(artifactIds,milestone)},scope:this})},scope:this})},getConfigForChart:function(artifactIds,milestone){var storeConfig={listeners:{load:function(store,data,success){}},find:{_ProjectHierarchy:this.projectId,_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},_ItemHierarchy:{$in:artifactIds},Children:null},fetch:["PlanEstimate","ScheduleState","FormattedID"],hydrate:["ScheduleState"],sort:{_ValidFrom:1},limit:1/0};return{calculatorType:"My.MilestoneBurnUpCalculator",calculatorConfig:{endDate:milestone.get("TargetDate")},storeType:"Rally.data.lookback.SnapshotStore",storeConfig:storeConfig,exceptionHandler:loggingSnapshotStoreExceptionHandler,chartConfig:{title:{text:milestone.get("Name")}}}}},dev?dev.app:null));

            Rally.launchApp('MilestoneBurnup', {
                name:"Milestone Burnup with Projection",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .highcharts-subtitle{margin-top:1em}
    </style>
</head>
<body>
</body>
</html>
