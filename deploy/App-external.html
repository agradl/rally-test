<!DOCTYPE html>
<html>
<head>
    <title>Milestone Burnup with Projection</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function resolvedPromise(value){return Deft.promise.Promise.when(value)}function rejectedPromise(error){var deferred=Ext.create("Deft.Deferred");return deferred.reject(error),deferred.promise}function loggingSnapshotStoreExceptionHandler(proxy,response,operation){var messages=JSON.parse(response.responseText),log=function(message){console.log(message)};console.log("Problem when obtaining snapshot data:"),messages.Errors.forEach(log),messages.Warnings.forEach(log),console.log("proxy =",window.proxy=proxy),console.log("response =",window.response=response),console.log("operation =",window.operation=operation)}function formatDate(date){return Rally.util.DateTime.format(date instanceof Date?date:new Date(date),"dMy")}function dateToIsoString(date){return date.toISOString().substring(0,10)}function linearProjectionStep(startIndex,startValue,endIndex,endValue){return startIndex>=0&&endIndex>startIndex&&startValue!=endValue?(endValue-startValue)/(endIndex-startIndex):(console.log("Unable to calculate projection step for values: (startIndex="+startIndex+", startValue="+startValue+", endIndex="+endIndex+", endValue="+endValue+")"),null)}function linearProjectionData(startIndex,startValue,endIndex,endValue,length){var projectionStep=linearProjectionStep(startIndex,startValue,endIndex,endValue);if(projectionStep){var data=[],i;for(i=0;startIndex>i;i++)data[i]=null;data[i]=startValue,i++;for(var targetIndex=startIndex+length;targetIndex>i;i++)data[i]=data[i-1]+projectionStep;return data}return null}function linearProjectionTargetIndex(startIndex,startValue,endIndex,endValue,targetValue){var projectionStep=linearProjectionStep(startIndex,startValue,endIndex,endValue);return projectionStep&&(endValue-startValue)*(targetValue-endValue)>=0?endIndex+Math.ceil((targetValue-endValue)/projectionStep):null}(function(){window.dev=window.dev||void 0,window.debug=window.debug||void 0;var originalDebug=console.debug;console.debug=function(){window.debug&&originalDebug.apply(this,arguments)}})();
                Ext.define("MilestoneBurnup",Ext.merge({extend:"Rally.app.App",componentCls:"app",getSettingsFields:function(){return[{name:"milestone",xtype:"mymilestonecombobox"}]},getMilestoneId:function(){return this.getSetting("milestone")},getProjectId:function(){return this.getContext().getProject().ObjectID},launch:function(){Ext.define("MyMilestoneBomboBox",{xtype:"rallymilestonecombobox",extend:"Rally.ui.combobox.MilestoneComboBox",alias:"widget.mymilestonecombobox",editable:!1,noEntryText:"-- choose a milestone --",allowNoEntry:!0}),this.getDataForChart().then({success:function(chartSetup){this.add(Ext.merge(this.createChart(),chartSetup))},failure:function(error){var lines=["Unable to fetch data. Click the gear and check your App Settings."];error&&error.error&&error.error.errors?lines=lines.concat(error.error.errors):lines.push(error),this.add({xtype:"container",html:lines.join("<br/>"),componentCls:"center"})},scope:this})},burnupCalculator:Ext.define("My.MilestoneBurnUpCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",getMetrics:function(){return[{field:"PlanEstimate",as:"In Progress",f:"filteredSum",filterField:"ScheduleState",filterValues:["In-Progress"],display:"column"},{field:"PlanEstimate",as:"Completed",f:"filteredSum",filterField:"ScheduleState",filterValues:["Completed"],display:"column"},{field:"PlanEstimate",as:"Accepted",f:"filteredSum",filterField:"ScheduleState",filterValues:["Accepted","Released"],display:"column"},{field:"PlanEstimate",as:"Planned",f:"sum",display:"line"}]},runCalculation:function(snapshots,snapshotsToSubtract){var data=this.callParent(arguments);return this.postProcessCalculation(data),data},postProcessCalculation:function(data){this.chartConfig={},this.truncateBeforeWorkStart(data),this.stripFutureBars(data),this.addPlotLines(data),this.addProjectionAndIdealLine(data),this.addSubtitle()},today:new Date,truncateBeforeWorkStart:function(data){var actualStartIndex=this.findDateIndex(data,this.today);data.series.forEach(function(series){if("Planned"!=series.name)for(var i=0;series.data.length>i;i++)if(series.data[i]>0&&actualStartIndex>i){actualStartIndex=i;break}}),data.series.forEach(function(series){series.data=series.data.slice(actualStartIndex)}),data.categories=data.categories.slice(actualStartIndex)},stripFutureBars:function(data){var currentIndex=this.findDateIndex(data,this.today)+1;data.series.forEach(function(series){if("Planned"!=series.name)for(var i=currentIndex;series.data.length>i;i++)series.data[i]=null})},addPlotLines:function(data){this.chartConfig.xAxis=this.chartConfig.xAxis||{},this.chartConfig.xAxis.plotLines=[{value:this.findDateIndex(data,this.endDate),color:"#000",width:2,label:{text:"planned end"}},{value:this.findDateIndex(data,this.today,!0),color:"#AAA",width:2,label:{text:"today"},dashStyle:"ShortDash"}]},addProjectionAndIdealLine:function(data){var acceptedData=this.getSeries(data,"Accepted"),todayIndex=this.findDateIndex(data,this.today),todayAcceptedPoints=acceptedData[todayIndex],todayPlannedPoints=this.getSeries(data,"Planned")[todayIndex],length=acceptedData.length,projectionData=linearProjectionData(0,0,todayIndex,todayAcceptedPoints,length);if(projectionData){data.series.push({name:"Projection",data:projectionData,type:"line",dashStyle:"Dash",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1});var idealData=linearProjectionData(0,0,length-1,todayPlannedPoints,length);idealData&&data.series.push({name:"Ideal",data:idealData,type:"line",dashStyle:"Dot",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1});var daysRemaining=linearProjectionTargetIndex(0,0,todayIndex,todayAcceptedPoints,todayPlannedPoints);this.projectedEndDate=Rally.util.DateTime.add(this.today,"day",daysRemaining)}},addSubtitle:function(){var parts=[];this.endDate&&parts.push("Planned End: "+formatDate(this.endDate)),this.projectedEndDate&&parts.push("Projected End: "+formatDate(this.projectedEndDate)),this.chartConfig.subtitle={text:parts.join(" &nbsp;&nbsp;&nbsp; "),useHTML:!0}},findDateIndex:function(data,date,floating){for(var searchedDateString=date instanceof Date?dateToIsoString(date):date,i=0;data.categories.length>i;i++){var dateString=data.categories[i];if(dateString>=searchedDateString)return dateString>searchedDateString?i-(floating?.5:1):i}return-1},getSeries:function(data,name){var series=data.series.find(function(aSeries){return aSeries.name==name});return series?series.data:[]}}),createChart:function(){return Ext.create("Rally.ui.chart.Chart",{chartColors:["#AEC","#8FCD88","#5EAC00","#005EB8","#000","#000"],chartConfig:{title:{text:"Milestone"},chart:{zoomType:"xy"},xAxis:{title:{text:"Date"},labels:{maxStaggerLines:1,step:5,formatter:function(){return formatDate(this.value)}}},yAxis:{title:{text:"Points"}},plotOptions:{line:{marker:{enabled:!0}},column:{stacking:!0},area:{stacking:!0,marker:{enabled:!1}}}},listeners:{snapshotsAggregated:function(chart){Ext.merge(chart.chartConfig,chart.calculator.chartConfig)}}})},getDataForChart:function(){return Deft.Promise.all([Rally.data.ModelFactory.getModel({type:"Milestone"}),this.getMilestoneId()]).then({success:function(modelAndId){var model=modelAndId[0],id=modelAndId[1];return id?model.load(id):rejectedPromise("No milestone set")},scope:this}).then({success:function(milestone){var context={project:this.getProjectId()?"/project/"+this.getProjectId():null},filter=Rally.data.wsapi.Filter.fromQueryString("(Milestones.ObjectID contains "+milestone.getId()+")");return Deft.Promise.all(["Defect","HierarchicalRequirement","PortfolioItem/TeamFeature"].map(function(artifactType){var deft=Ext.create("Rally.data.wsapi.Store",{model:artifactType,filters:filter,fetch:["ObjectID"],context:context,autoLoad:!0}).load();return deft})).then({success:function(results){var artifactIds=results.reduce(function(result,records){return result.concat(records.map(function(record){return+record.raw.ObjectID}))},[]);return this.getConfigForChart(artifactIds,milestone)},scope:this})},scope:this})},getConfigForChart:function(artifactIds,milestone){var storeConfig={listeners:{load:function(store,data,success){}},find:{_ProjectHierarchy:this.projectId,_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},_ItemHierarchy:{$in:artifactIds},Children:null},fetch:["PlanEstimate","ScheduleState","FormattedID"],hydrate:["ScheduleState"],sort:{_ValidFrom:1},limit:1/0};return{calculatorType:"My.MilestoneBurnUpCalculator",calculatorConfig:{endDate:milestone.get("TargetDate")},storeType:"Rally.data.lookback.SnapshotStore",storeConfig:storeConfig,exceptionHandler:loggingSnapshotStoreExceptionHandler,queryErrorMessage:"No work items found for milestone <strong>"+milestone.get("Name")+"</strong>.",chartConfig:{title:{text:milestone.get("Name")}}}}},dev?dev.app:null));

            Rally.launchApp('MilestoneBurnup', {
                name:"Milestone Burnup with Projection",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .center{text-align:center}
    </style>
</head>
<body>
</body>
</html>
