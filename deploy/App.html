<!DOCTYPE html>
<html>
<head>
    <title>Milestone Burnup with Projection</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function resolvedPromise(value){return Deft.promise.Promise.when(value)}function rejectedPromise(error){var deferred=Ext.create("Deft.Deferred");return deferred.reject(error),deferred.promise}function loggingSnapshotStoreExceptionHandler(proxy,response,operation){var messages=JSON.parse(response.responseText),log=function(message){console.log(message)};console.log("Problem when obtaining snapshot data:"),messages.Errors.forEach(log),messages.Warnings.forEach(log),console.log("proxy:",proxy,"response:",response,"operation:",operation)}function formatDate(date){return Rally.util.DateTime.format(date instanceof Date?date:new Date(date),"dMy")}function dateToIsoString(date){return date.toISOString().substring(0,10)}function addBusinessDays(date,businessDays){for(var days=date.getDate(),d=date.getDay();businessDays>0;)++days,d=(d+1)%7,0!==d&&6!=d&&--businessDays;return date.setDate(days),date}(function(){window.dev=window.dev||void 0,window.debug=window.debug||void 0,window.debug||(console.debug=function(){})})(),Ext.define("My.BurnUpCalculation",{calculate:function(data,config){return this.calcConfig={today:config.today||new Date,endDate:config.endDate,customStartDate:config.customStartDate,maxDaysAfterPlannedEnd:config.maxDaysAfterPlannedEnd,customProjectionStartDate:config.customProjectionStartDate},this.chartConfig={xAxis:{plotLines:[]},subtitle:{useHTML:!0}},this.adjustChartStart(data),this.stripFutureBars(data),this.addProjectionsLinesAndSubtitle(data),this.reformatDates(data),this.chartConfig},adjustChartStart:function(data){var firstInProgressIndex=this.findDateIndex(data.categories,this.calcConfig.today,!1,data.categories.length);data.series.forEach(function(series){if("Planned"!=series.name)for(var i=0;series.data.length>i;i++)if(series.data[i]>0&&firstInProgressIndex>i){firstInProgressIndex=i;break}});var startIndex=this.calcConfig.customStartDate?this.findDateIndex(data.categories,this.calcConfig.customStartDate,!1,firstInProgressIndex):firstInProgressIndex;data.series.forEach(function(series){series.data=series.data.slice(startIndex)}),data.categories=data.categories.slice(startIndex)},stripFutureBars:function(data){var currentIndex=this.findDateIndex(data.categories,this.calcConfig.today,!1,data.categories.length)+1;data.series.forEach(function(series){if("Planned"!=series.name)for(var i=currentIndex;series.data.length>i;i++)series.data[i]=null})},addVerticalLine:function(label,index,config){if(-1!=index){for(var plotLines=this.chartConfig.xAxis.plotLines,i=0;plotLines.length>i;i++)if(plotLines[i].value==index)return;plotLines.push(Ext.merge({label:{text:label},value:index,width:2,color:"#000"},config))}},addSeriesLine:function(data,name,series,config){series&&data.series.push(Ext.merge({name:name,data:series,type:"line",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1},config))},addSubtitleText:function(text){var subtitle=this.chartConfig.subtitle;subtitle.text=subtitle.text?subtitle.text+" &nbsp;&nbsp;&nbsp; "+text:text},addProjectionsLinesAndSubtitle:function(data){var acceptedData=this.getSeriesData(data,"Accepted"),plannedData=this.getSeriesData(data,"Planned"),dates=data.categories,todayIndex=this.findDateIndex(dates,this.calcConfig.today),plannedEndIndex=this.findDateIndex(dates,this.calcConfig.endDate),todayAcceptedPoints=acceptedData[todayIndex],todayPlannedPoints=plannedData[todayIndex],projectionStart=this.getProjectionStart(dates,acceptedData);this.addVerticalLine("planned end",plannedEndIndex),this.addVerticalLine("today",this.findDateIndex(dates,this.calcConfig.today,!0),{color:"#BBB",dashStyle:"ShortDash"});var projectedDateIndex=this.linearProjectionTargetIndex(projectionStart.index,projectionStart.points,todayIndex,todayAcceptedPoints,todayPlannedPoints);if(projectedDateIndex&&todayPlannedPoints>todayAcceptedPoints){for(var maxDaysAfterPlannedEnd=this.calcConfig.maxDaysAfterPlannedEnd||0,projectionEndIndex=Math.min(projectedDateIndex,(-1==plannedEndIndex?todayIndex:plannedEndIndex)+maxDaysAfterPlannedEnd),j=Math.max(todayIndex,plannedEndIndex);projectionEndIndex>j;j++)plannedData.push(todayPlannedPoints),data.categories.push(addBusinessDays(new Date(data.categories[data.categories.length-1]),1));var projectionSeries=this.linearProjectionData(projectionStart.index,projectionStart.points,todayIndex,todayAcceptedPoints,projectionEndIndex,todayPlannedPoints);this.addSeriesLine(data,"Projection",projectionSeries,{dashStyle:"Dash"}),projectionEndIndex>=projectedDateIndex&&this.addVerticalLine("projected end",projectedDateIndex,{color:"#BBB"}),this.projectedEndDate=addBusinessDays(new Date(data.categories[0]),projectedDateIndex)}if(this.calcConfig.endDate){var idealData=this.linearProjectionData(projectionStart.index,projectionStart.points,plannedEndIndex,todayPlannedPoints,plannedEndIndex);this.addSeriesLine(data,"Ideal",idealData,{dashStyle:"Dot"}),this.addSubtitleText("Planned End: "+formatDate(this.calcConfig.endDate))}this.projectedEndDate&&this.addSubtitleText("Projected End: "+formatDate(this.projectedEndDate))},getProjectionStart:function(dates,acceptedData){var index;if(this.calcConfig.customProjectionStartDate)index=this.findDateIndex(dates,this.calcConfig.customProjectionStartDate);else for(index=0;acceptedData.length>index&&!(acceptedData[index]>0);index++);return{index:index,points:acceptedData[index]||0}},findDateIndex:function(dates,date,floating,defaultIndex){for(var searchedDateString=date instanceof Date?dateToIsoString(date):date,i=0;dates.length>i;i++){var dateString=dates[i];if(dateString>=searchedDateString)return dateString>searchedDateString?i-(floating?.5:1):i}return defaultIndex||-1},getSeriesData:function(data,name){for(var i=0;data.series.length>i;i++){var s=data.series[i];if(s.name==name)return s.data}return[]},reformatDates:function(data){data.categories=data.categories.map(function(date){return formatDate(date)})},linearProjectionStep:function(startIndex,startValue,endIndex,endValue){return startIndex>=0&&endIndex>startIndex&&startValue!=endValue?(endValue-startValue)/(endIndex-startIndex):(console.log("Unable to calculate projection step for values: (startIndex="+startIndex+", startValue="+startValue+", endIndex="+endIndex+", endValue="+endValue+")"),null)},linearProjectionData:function(startIndex,startValue,endIndex,endValue,indexLimit,valueLimit){var projectionStep=this.linearProjectionStep(startIndex,startValue,endIndex,endValue);if(projectionStep&&0!==indexLimit){var data=[],i;for(i=0;startIndex>i;i++)data[i]=null;data[i]=startValue,i++;for(var actualIndexLimit=indexLimit||1/0;actualIndexLimit>=i&&(!valueLimit||valueLimit>=data[i-1]);i++)data[i]=data[i-1]+projectionStep;return data}return null},linearProjectionTargetIndex:function(startIndex,startValue,endIndex,endValue,targetValue){var projectionStep=this.linearProjectionStep(startIndex,startValue,endIndex,endValue);return projectionStep&&(endValue-startValue)*(targetValue-endValue)>=0?endIndex+Math.ceil((targetValue-endValue)/projectionStep):null}});
                Ext.define("MilestoneBurnupWithProjection",Ext.merge({extend:"Rally.app.App",componentCls:"app",getSettingsFields:function(){var LABEL_WIDTH=170,LABEL_ALIGN="right";return[{name:"milestone",xtype:"mymilestonecombobox"},{name:"customStartDate",xtype:"rallydatefield",label:"Custom Chart Start Date",config:{labelWidth:LABEL_WIDTH,labelAlign:LABEL_ALIGN}},{name:"customProjectionStartDate",xtype:"rallydatefield",label:"Custom Projection Start Date",config:{labelWidth:LABEL_WIDTH,labelAlign:LABEL_ALIGN}},{name:"maxDaysAfterPlannedEnd",xtype:"rallynumberfield",label:"Max Days Shown After Planned End",config:{labelWidth:LABEL_WIDTH,labelAlign:LABEL_ALIGN,minValue:0,maxValue:365}}]},config:{defaultSettings:{maxDaysAfterPlannedEnd:30}},getMilestoneId:function(){return this.getSetting("milestone")},getProjectId:function(){return this.getContext().getProject().ObjectID},launch:function(){Ext.define("MyMilestoneComboBox",{extend:"Rally.ui.combobox.MilestoneComboBox",alias:"widget.mymilestonecombobox",editable:!1,config:{labelText:"Milestone",hideLabel:!1}}),this.getDataForChart().then({success:function(chartSetup){this.add(Ext.merge(this.createChart(),chartSetup))},failure:function(error){var lines=["Unable to fetch data. Click the gear and check your App Settings."];error&&error.error&&error.error.errors?lines=lines.concat(error.error.errors):lines.push(error),this.add({xtype:"container",html:lines.join("<br/>"),componentCls:"center"})},scope:this})},burnupCalculator:Ext.define("My.MilestoneBurnUpCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",mixins:["My.BurnUpCalculation"],getMetrics:function(){return[{field:"PlanEstimate",as:"In Progress",f:"filteredSum",filterField:"ScheduleState",filterValues:["In-Progress"],display:"column"},{field:"PlanEstimate",as:"Completed",f:"filteredSum",filterField:"ScheduleState",filterValues:["Completed"],display:"column"},{field:"PlanEstimate",as:"Accepted",f:"filteredSum",filterField:"ScheduleState",filterValues:["Accepted","Released"],display:"column"},{field:"PlanEstimate",as:"Planned",f:"sum",display:"line"}]},runCalculation:function(snapshots,snapshotsToSubtract){var data=this.callParent(arguments);return this.chartConfig=this.calculate(data,this.calculationConfig),data}}),createChart:function(){return Ext.create("Rally.ui.chart.Chart",{chartColors:["#AEC","#8FCD88","#5EAC00","#005EB8","#000","#000"],chartConfig:{title:{text:"Milestone"},chart:{zoomType:"xy"},xAxis:{title:{text:"Date"},labels:{maxStaggerLines:1,step:5}},yAxis:{title:{text:"Points"}},plotOptions:{line:{marker:{enabled:!0}},column:{stacking:!0},area:{stacking:!0,marker:{enabled:!1}}}},listeners:{snapshotsAggregated:function(chart){Ext.merge(chart.chartConfig,chart.calculator.chartConfig)}}})},getDataForChart:function(){return Deft.Promise.all([Rally.data.ModelFactory.getModel({type:"Milestone"}),this.getMilestoneId()]).then({success:function(milestoneModelAndId){var model=milestoneModelAndId[0],id=milestoneModelAndId[1];return id?model.load(id):rejectedPromise("No milestone set")},scope:this}).then({success:function(milestone){var context={project:this.getProjectId()?"/project/"+this.getProjectId():null},filter=Rally.data.wsapi.Filter.fromQueryString("(Milestones.ObjectID contains "+milestone.getId()+")");return Deft.Promise.all(["Defect","HierarchicalRequirement","PortfolioItem/TeamFeature"].map(function(artifactType){return Ext.create("Rally.data.wsapi.Store",{model:artifactType,filters:filter,fetch:["ObjectID"],context:context,autoLoad:!0}).load()})).then({success:function(results){var artifactIds=results.reduce(function(result,records){return result.concat(records.map(function(record){return+record.raw.ObjectID}))},[]);return this.getConfigForChart(artifactIds,milestone)},scope:this})},scope:this})},getConfigForChart:function(artifactIds,milestone){var storeConfig={listeners:{load:function(store,data,success){}},find:{_ProjectHierarchy:this.projectId,_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},_ItemHierarchy:{$in:artifactIds},Children:null},fetch:["PlanEstimate","ScheduleState","FormattedID"],hydrate:["ScheduleState"],sort:{_ValidFrom:1},limit:1/0};return{calculatorType:"My.MilestoneBurnUpCalculator",calculatorConfig:{endDate:milestone.get("TargetDate"),calculationConfig:{endDate:milestone.get("TargetDate"),customStartDate:this.getSetting("customStartDate"),customProjectionStartDate:this.getSetting("customProjectionStartDate"),maxDaysAfterPlannedEnd:this.getSetting("maxDaysAfterPlannedEnd")}},storeType:"Rally.data.lookback.SnapshotStore",storeConfig:storeConfig,exceptionHandler:loggingSnapshotStoreExceptionHandler,queryErrorMessage:"No work items found for milestone <strong>"+milestone.get("Name")+"</strong>.",chartConfig:{title:{text:milestone.get("Name")}}}}},dev?dev.app:null));

            Rally.launchApp('MilestoneBurnupWithProjection', {
                name:"Milestone Burnup with Projection",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .center{text-align:center}
    </style>
</head>
<body>
</body>
</html>
