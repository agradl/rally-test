<!DOCTYPE html>
<html>
<head>
    <title>Milestone Burnup with Projection</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function resolvedPromise(value){return Deft.promise.Promise.when(value)}function rejectedPromise(error){var deferred=Ext.create("Deft.Deferred");return deferred.reject(error),deferred.promise}function loggingSnapshotStoreExceptionHandler(proxy,response,operation){var messages=JSON.parse(response.responseText),log=function(message){console.log(message)};console.log("Problem when obtaining snapshot data:"),messages.Errors.forEach(log),messages.Warnings.forEach(log),console.log("proxy:",proxy,"response:",response,"operation:",operation)}function formatDate(date){return Rally.util.DateTime.format(date instanceof Date?date:new Date(date),"dMy")}function dateToIsoString(date){return date.toISOString().substring(0,10)}function addBusinessDays(date,businessDays){for(var days=date.getDate(),d=date.getDay();businessDays>0;)++days,d=(d+1)%7,0!==d&&6!=d&&--businessDays;return date.setDate(days),date}(function(){window.dev=window.dev||void 0,window.debug=window.debug||void 0,window.debug||(console.debug=function(){})})(),Ext.define("My.BurnUpCalculation",{calculate:function(data,config){return this.calcConfig.today=config.today||new Date,this.calcConfig.endDate=config.endDate,this.calcConfig.customStartDate=config.customStartDate,this.adjustChartStart(data),this.stripFutureBars(data),this.addPlotLines(data),this.addProjectionAndIdealLine(data),this.addSubtitle(),this.reformatDates(data),this.chartConfig},calcConfig:{},chartConfig:{},adjustChartStart:function(data){var firstInProgressIndex=this.findDateIndex(data,this.calcConfig.today,!1,data.categories.length);data.series.forEach(function(series){if("Planned"!=series.name)for(var i=0;series.data.length>i;i++)if(series.data[i]>0&&firstInProgressIndex>i){firstInProgressIndex=i;break}});var startIndex=this.calcConfig.customStartDate?this.findDateIndex(data,this.calcConfig.customStartDate,!1,firstInProgressIndex):firstInProgressIndex;data.series.forEach(function(series){series.data=series.data.slice(startIndex)}),data.categories=data.categories.slice(startIndex)},stripFutureBars:function(data){var currentIndex=this.findDateIndex(data,this.calcConfig.today,!1,data.categories.length)+1;data.series.forEach(function(series){if("Planned"!=series.name)for(var i=currentIndex;series.data.length>i;i++)series.data[i]=null})},addPlotLines:function(data){this.chartConfig.xAxis=this.chartConfig.xAxis||{},this.chartConfig.xAxis.plotLines=[{value:this.findDateIndex(data,this.calcConfig.endDate),color:"#000",width:2,label:{text:"planned end"}},{value:this.findDateIndex(data,this.calcConfig.today,!0),color:"#AAA",width:2,label:{text:"today"},dashStyle:"ShortDash"}]},addProjectionAndIdealLine:function(data){for(var acceptedData=this.getSeriesData(data,"Accepted"),todayIndex=this.findDateIndex(data,this.calcConfig.today),endIndex=this.findDateIndex(data,this.calcConfig.endDate),todayAcceptedPoints=acceptedData[todayIndex],todayPlannedPoints=this.getSeriesData(data,"Planned")[todayIndex],firstAcceptedIndex,firstAcceptedPoints,i=0;acceptedData.length>i;i++)if(acceptedData[i]>0){firstAcceptedIndex=i,firstAcceptedPoints=acceptedData[i];break}var projectionStartIndex=firstAcceptedIndex||0,projectionStartPoints=firstAcceptedPoints||0,projectionData=this.linearProjectionData(projectionStartIndex,projectionStartPoints,todayIndex,todayAcceptedPoints,endIndex+1,todayPlannedPoints);if(projectionData){data.series.push({name:"Projection",data:projectionData,type:"line",dashStyle:"Dash",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1});var projectedDaysRemaining=this.linearProjectionTargetIndex(projectionStartIndex,projectionStartPoints,todayIndex,todayAcceptedPoints,todayPlannedPoints);this.projectedEndDate=addBusinessDays(new Date(data.categories[0]),projectedDaysRemaining)}if(this.calcConfig.endDate){var idealData=this.linearProjectionData(projectionStartIndex,projectionStartPoints,endIndex,todayPlannedPoints,endIndex+1);idealData&&data.series.push({name:"Ideal",data:idealData,type:"line",dashStyle:"Dot",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1})}},addSubtitle:function(){var parts=[];this.calcConfig.endDate&&parts.push("Planned End: "+formatDate(this.calcConfig.endDate)),this.projectedEndDate&&parts.push("Projected End: "+formatDate(this.projectedEndDate)),this.chartConfig.subtitle={text:parts.join(" &nbsp;&nbsp;&nbsp; "),useHTML:!0}},findDateIndex:function(data,date,floating,defaultIndex){for(var searchedDateString=date instanceof Date?dateToIsoString(date):date,i=0;data.categories.length>i;i++){var dateString=data.categories[i];if(dateString>=searchedDateString)return dateString>searchedDateString?i-(floating?.5:1):i}return defaultIndex||-1},getSeriesData:function(data,name){for(var i=0;data.series.length>i;i++){var s=data.series[i];if(s.name==name)return s.data}return[]},reformatDates:function(data){data.categories=data.categories.map(function(date){return formatDate(date)})},linearProjectionStep:function(startIndex,startValue,endIndex,endValue){return startIndex>=0&&endIndex>startIndex&&startValue!=endValue?(endValue-startValue)/(endIndex-startIndex):(console.log("Unable to calculate projection step for values: (startIndex="+startIndex+", startValue="+startValue+", endIndex="+endIndex+", endValue="+endValue+")"),null)},linearProjectionData:function(startIndex,startValue,endIndex,endValue,indexLimit,valueLimit){var projectionStep=this.linearProjectionStep(startIndex,startValue,endIndex,endValue);if(projectionStep){var data=[],i;for(i=0;startIndex>i;i++)data[i]=null;data[i]=startValue,i++;for(var actualIndexLimit=indexLimit||1/0;actualIndexLimit>i&&(!valueLimit||valueLimit>=data[i-1]);i++)data[i]=data[i-1]+projectionStep;return data}return null},linearProjectionTargetIndex:function(startIndex,startValue,endIndex,endValue,targetValue){var projectionStep=this.linearProjectionStep(startIndex,startValue,endIndex,endValue);return projectionStep&&(endValue-startValue)*(targetValue-endValue)>=0?endIndex+Math.round((targetValue-endValue)/projectionStep):null}});
                Ext.define("MilestoneBurnupWithProjection",Ext.merge({extend:"Rally.app.App",componentCls:"app",getSettingsFields:function(){return[{name:"milestone",xtype:"mymilestonecombobox"},{name:"customStartDate",xtype:"rallydatefield",label:"Custom Start Date",config:{labelWidth:150}}]},getMilestoneId:function(){return this.getSetting("milestone")},getProjectId:function(){return this.getContext().getProject().ObjectID},launch:function(){Ext.define("MyMilestoneComboBox",{extend:"Rally.ui.combobox.MilestoneComboBox",alias:"widget.mymilestonecombobox",editable:!1,config:{labelText:"Milestone",hideLabel:!1}}),this.getDataForChart().then({success:function(chartSetup){this.add(Ext.merge(this.createChart(),chartSetup))},failure:function(error){var lines=["Unable to fetch data. Click the gear and check your App Settings."];error&&error.error&&error.error.errors?lines=lines.concat(error.error.errors):lines.push(error),this.add({xtype:"container",html:lines.join("<br/>"),componentCls:"center"})},scope:this})},burnupCalculator:Ext.define("My.MilestoneBurnUpCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",mixins:["My.BurnUpCalculation"],getMetrics:function(){return[{field:"PlanEstimate",as:"In Progress",f:"filteredSum",filterField:"ScheduleState",filterValues:["In-Progress"],display:"column"},{field:"PlanEstimate",as:"Completed",f:"filteredSum",filterField:"ScheduleState",filterValues:["Completed"],display:"column"},{field:"PlanEstimate",as:"Accepted",f:"filteredSum",filterField:"ScheduleState",filterValues:["Accepted","Released"],display:"column"},{field:"PlanEstimate",as:"Planned",f:"sum",display:"line"}]},runCalculation:function(snapshots,snapshotsToSubtract){var data=this.callParent(arguments);return this.chartConfig=this.calculate(data,this.calculationConfig),data}}),createChart:function(){return Ext.create("Rally.ui.chart.Chart",{chartColors:["#AEC","#8FCD88","#5EAC00","#005EB8","#000","#000"],chartConfig:{title:{text:"Milestone"},chart:{zoomType:"xy"},xAxis:{title:{text:"Date"},labels:{maxStaggerLines:1,step:5}},yAxis:{title:{text:"Points"}},plotOptions:{line:{marker:{enabled:!0}},column:{stacking:!0},area:{stacking:!0,marker:{enabled:!1}}}},listeners:{snapshotsAggregated:function(chart){Ext.merge(chart.chartConfig,chart.calculator.chartConfig)}}})},getDataForChart:function(){return Deft.Promise.all([Rally.data.ModelFactory.getModel({type:"Milestone"}),this.getMilestoneId()]).then({success:function(milestoneModelAndId){var model=milestoneModelAndId[0],id=milestoneModelAndId[1];return id?model.load(id):rejectedPromise("No milestone set")},scope:this}).then({success:function(milestone){var context={project:this.getProjectId()?"/project/"+this.getProjectId():null},filter=Rally.data.wsapi.Filter.fromQueryString("(Milestones.ObjectID contains "+milestone.getId()+")");return Deft.Promise.all(["Defect","HierarchicalRequirement","PortfolioItem/TeamFeature"].map(function(artifactType){return Ext.create("Rally.data.wsapi.Store",{model:artifactType,filters:filter,fetch:["ObjectID"],context:context,autoLoad:!0}).load()})).then({success:function(results){var artifactIds=results.reduce(function(result,records){return result.concat(records.map(function(record){return+record.raw.ObjectID}))},[]);return this.getConfigForChart(artifactIds,milestone)},scope:this})},scope:this})},getConfigForChart:function(artifactIds,milestone){var storeConfig={listeners:{load:function(store,data,success){}},find:{_ProjectHierarchy:this.projectId,_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},_ItemHierarchy:{$in:artifactIds},Children:null},fetch:["PlanEstimate","ScheduleState","FormattedID"],hydrate:["ScheduleState"],sort:{_ValidFrom:1},limit:1/0};return{calculatorType:"My.MilestoneBurnUpCalculator",calculatorConfig:{endDate:milestone.get("TargetDate"),calculationConfig:{endDate:milestone.get("TargetDate"),customStartDate:this.getSetting("customStartDate")}},storeType:"Rally.data.lookback.SnapshotStore",storeConfig:storeConfig,exceptionHandler:loggingSnapshotStoreExceptionHandler,queryErrorMessage:"No work items found for milestone <strong>"+milestone.get("Name")+"</strong>.",chartConfig:{title:{text:milestone.get("Name")}}}}},dev?dev.app:null));

            Rally.launchApp('MilestoneBurnupWithProjection', {
                name:"Milestone Burnup with Projection",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .center{text-align:center}
    </style>
</head>
<body>
</body>
</html>
