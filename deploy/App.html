<!DOCTYPE html>
<html>
<head>
    <title>Milestone Burnup with Projection</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function resolvedPromise(value){return Deft.promise.Promise.when(value)}function rejectedPromise(error){var deferred=Ext.create("Deft.Deferred");return deferred.reject(error),deferred.promise}function promiseAll(array){return 0===array.length?[]:Deft.Promise.all(array)}function getRallyRecordType(record){return record&&record.getData()._type}function getRallyIdFromRef(ref,type){return+ref.slice(type.length+2)}function formatMilestone(milestone,context){return'<span class="artifact-icon icon-milestone" style="transform:rotate(20deg);color: '+milestone.get("DisplayColor")+';"></span>'+'<a target="_blank" style="color:#274b6d" href="'+getMilestoneLink(milestone,context)+'">'+milestone.get("Name")+"</a>"}function getMilestoneLink(milestone,context){return"https://rally1.rallydev.com/#/"+context.getProject().ObjectID+"d/detail"+milestone.getUri()}function formatRelease(release,context){return'<a target="_blank" style="color:#274b6d" href="'+getReleaseLink(release,context)+'">'+release.get("Name")+"</a>"}function getReleaseLink(release,context){return"https://rally1.rallydev.com/slm/rl/edit.sp?cpoid="+context.getProject().ObjectID+"&projectScopeUp="+context.getProjectScopeUp()+"&projectScopeDown="+context.getProjectScopeDown()+"&oid="+release.getId()+"&typeDef=27154375554"}function hasOwnProperties(object,minNumber){minNumber=minNumber?minNumber:1;for(var property in object)if(object.hasOwnProperty(property)&&!--minNumber)return!0;return!1}function loggingSnapshotStoreExceptionHandler(proxy,response,operation){var messages=JSON.parse(response.responseText),log=function(message){console.log(message)};console.log("Problem when obtaining snapshot data:"),messages.Errors.forEach(log),messages.Warnings.forEach(log),console.log("proxy:",proxy,"response:",response,"operation:",operation)}function formatDate(date){return Rally.util.DateTime.format(date instanceof Date?date:new Date(date),"dMy")}function dateToIsoString(date){return date.toISOString().substring(0,10)}function joinNotEmpty(array,glue,prefixIfNotEmpty,suffixIfNotEmpty){var joined=array.filter(function(element){return!!element}).join(glue),prefix=prefixIfNotEmpty?prefixIfNotEmpty:"",suffix=suffixIfNotEmpty?suffixIfNotEmpty:"";return joined&&(prefix||suffix)?prefix+joined+suffix:joined}function addBusinessDays(date,businessDays){for(var result=new Date(date),days=result.getDate(),d=result.getDay();businessDays>0;)++days,d=(d+1)%7,0!==d&&6!=d&&--businessDays;return result.setDate(days),result}(function(){window.dev=window.dev||void 0,window.debug=window.debug||void 0,window.debug||(console.debug=function(){})})(),Ext.define("My.BurnUpCalculation",{calculate:function(data,config){return this.calcConfig={today:config.today||new Date,maxEndDate:config.maxEndDate,auxDates:config.auxDates,plannedEndDate:config.plannedEndDate,customStartDate:config.customStartDate,maxDaysAfterPlannedEnd:config.maxDaysAfterPlannedEnd,customTrendStartDate:config.customTrendStartDate,smallDisplay:config.smallDisplay},this.chartConfig={xAxis:{plotLines:[]},subtitle:{useHTML:!0}},this.adjustChartStart(data),this.stripFutureBars(data),this.addTrendLinesAndSubtitle(data),this.adjustDataAndChartConfig(data),this.chartConfig},adjustChartStart:function(data){var firstInProgressIndex=this.findDateIndex(data.categories,this.calcConfig.today,!1,data.categories.length);data.series.forEach(function(series){if("Scope"!=series.name)for(var i=0;series.data.length>i;i++)if(series.data[i]>0&&firstInProgressIndex>i){firstInProgressIndex=i;break}});var startIndex=this.calcConfig.customStartDate?this.findDateIndex(data.categories,this.calcConfig.customStartDate,!1,0):firstInProgressIndex;data.series.forEach(function(series){series.data=series.data.slice(startIndex)}),data.categories=data.categories.slice(startIndex)},stripFutureBars:function(data){var currentIndex=this.findDateIndex(data.categories,this.calcConfig.today,!1,data.categories.length)+1;data.series.forEach(function(series){if("Scope"!=series.name)for(var i=currentIndex;series.data.length>i;i++)series.data[i]=null})},addVerticalLine:function(label,index,config){if(-1!=index){for(var plotLines=this.chartConfig.xAxis.plotLines,i=0;plotLines.length>i;i++)plotLines[i].value==index&&(label=plotLines[i].label.text+" / "+label,plotLines.splice(i,1));plotLines.push(Ext.merge({label:{text:label,y:3,x:3},value:index,width:2,color:"#000",zIndex:5},config))}},addSeriesLine:function(data,name,series,config){series&&data.series.push(Ext.merge({name:name,data:series,type:"line",marker:{enabled:!1},enableMouseTracking:!1,lineWidth:1},config))},addSubtitleText:function(text){var subtitle=this.chartConfig.subtitle;subtitle.text=subtitle.text?subtitle.text+" &nbsp;&nbsp;&nbsp; "+text:text},addTrendLinesAndSubtitle:function(data){var config=this.calcConfig,acceptedData=this.getSeriesData(data,"Accepted"),plannedData=this.getSeriesData(data,"Scope"),dates=data.categories,todayIndex=this.findDateIndex(dates,config.today),plannedEndIndex=this.findDateIndex(dates,this.calcConfig.plannedEndDate),todayAcceptedPoints=acceptedData[todayIndex],todayPlannedPoints=plannedData[todayIndex],trendStart=this.getTrendStart(dates,acceptedData),projectedEndVerticalLineIndex,projectedDateIndex=this.trendTargetIndex(trendStart.index,trendStart.points,todayIndex,todayAcceptedPoints,todayPlannedPoints);if(projectedDateIndex&&todayPlannedPoints>todayAcceptedPoints){for(var maxDaysAfterPlannedEnd=this.calcConfig.maxDaysAfterPlannedEnd||0,trendEndIndex=Math.min(projectedDateIndex,(-1==plannedEndIndex?todayIndex:plannedEndIndex)+maxDaysAfterPlannedEnd),j=Math.max(todayIndex,plannedEndIndex,dates.length-1);trendEndIndex>j;j++)plannedData.push(todayPlannedPoints),dates.push(dateToIsoString(addBusinessDays(new Date(dates[dates.length-1]),1)));var trendSeries=this.trendData(trendStart.index,trendStart.points,todayIndex,todayAcceptedPoints,trendEndIndex,todayPlannedPoints);this.addSeriesLine(data,"Trend",trendSeries,{dashStyle:"Dash"}),trendEndIndex>=projectedDateIndex&&(projectedEndVerticalLineIndex=projectedDateIndex),this.projectedEndDate=addBusinessDays(new Date(dates[0]),projectedDateIndex)}if(todayAcceptedPoints==todayPlannedPoints&&todayPlannedPoints>0&&todayIndex>plannedEndIndex){for(var i=dates.length-1;(acceptedData[i]==todayPlannedPoints||null===acceptedData[i])&&plannedData[i]==todayPlannedPoints;)i--;i+=2;var deleteCount=dates.length;dates.splice(i,deleteCount),acceptedData.splice(i,deleteCount),plannedData.splice(i,deleteCount),this.getSeriesData(data,"In Progress").splice(i,deleteCount),this.getSeriesData(data,"Completed").splice(i,deleteCount)}if(this.calcConfig.plannedEndDate){var idealData=this.trendData(trendStart.index,trendStart.points,plannedEndIndex,plannedData[plannedEndIndex],plannedEndIndex);this.addSeriesLine(data,"Ideal",idealData,{dashStyle:"Dot"}),this.addSubtitleText("Planned End: "+formatDate(this.calcConfig.plannedEndDate))}if(this.projectedEndDate&&this.addSubtitleText("Projected End: "+formatDate(this.projectedEndDate)),config.auxDates&&hasOwnProperties(config.auxDates,2))for(var auxDate in config.auxDates)config.auxDates.hasOwnProperty(auxDate)&&this.addVerticalLine(config.auxDates[auxDate],this.findDateIndex(dates,auxDate,!0),{width:1,label:{x:2}});this.addVerticalLine("Today",this.findDateIndex(dates,config.today,!0),{color:"#AAA",dashStyle:"ShortDash"}),this.addVerticalLine("Planned End",this.findDateIndex(dates,config.plannedEndDate,!0)),projectedEndVerticalLineIndex&&this.addVerticalLine("Projected End",projectedEndVerticalLineIndex,{dashStyle:"ShortDash"})},getTrendStart:function(dates,acceptedData){var index;if(this.calcConfig.customTrendStartDate)index=this.findDateIndex(dates,this.calcConfig.customTrendStartDate);else for(index=0;acceptedData.length>index&&!(acceptedData[index]>0);index++);return{index:index,points:acceptedData[index]||0}},findDateIndex:function(dates,date,floating,defaultIndex){var searchedDateString=date instanceof Date?dateToIsoString(date):date;if(dates.length>0&&searchedDateString>=dates[0])for(var i=0;dates.length>i;i++){var dateString=dates[i];if(dateString>=searchedDateString)return dateString>searchedDateString?i-(floating?.5:1):i}return defaultIndex||0===defaultIndex?defaultIndex:-1},getSeriesData:function(data,name){for(var i=0;data.series.length>i;i++){var s=data.series[i];if(s.name==name)return s.data}return[]},adjustDataAndChartConfig:function(data){data.categories=data.categories.map(function(date){return formatDate(date)});var threshold=data.categories.length*(this.calcConfig.smallDisplay?2:1),step,lineWidth,groupPadding;if(threshold>240)groupPadding=.05,lineWidth=2,step=20;else{if(!(threshold>120))return;groupPadding=.1,lineWidth=3,step=10}Ext.merge(this.chartConfig,{xAxis:{labels:{step:step}},plotOptions:{line:{lineWidth:lineWidth},column:{groupPadding:groupPadding}}})},trendStep:function(startIndex,startValue,endIndex,endValue){return startIndex>=0&&endIndex>startIndex&&startValue!=endValue?(endValue-startValue)/(endIndex-startIndex):(console.log("Unable to calculate trend step for values: (startIndex="+startIndex+", startValue="+startValue+", endIndex="+endIndex+", endValue="+endValue+")"),null)},trendData:function(startIndex,startValue,endIndex,endValue,indexLimit,valueLimit){var trendStep=this.trendStep(startIndex,startValue,endIndex,endValue);if(trendStep&&0!==indexLimit){var data=[],i;for(i=0;startIndex>i;i++)data[i]=null;data[i]=startValue,i++;for(var actualIndexLimit=indexLimit||1/0;actualIndexLimit>=i&&(!valueLimit||valueLimit>=data[i-1]);i++)data[i]=data[i-1]+trendStep;return data}return null},trendTargetIndex:function(startIndex,startValue,endIndex,endValue,targetValue){var trendStep=this.trendStep(startIndex,startValue,endIndex,endValue);return trendStep&&(endValue-startValue)*(targetValue-endValue)>=0?endIndex+Math.ceil((targetValue-endValue)/trendStep):null}});
                Ext.define("MilestoneBurnupWithProjection",Ext.merge({extend:"Rally.app.App",componentCls:"app",getContextTimebox:function(){if(!this._timeboxFromScope){var timeboxScope=this.getContext().getTimeboxScope();this._timeboxFromScope=timeboxScope&&timeboxScope.getRecord()}return this._timeboxFromScope},getSettingsFields:function(){var defaultConfig={labelWidth:170,labelAlign:"right"},checkboxConfig={labelWidth:360},settingsFields=[{name:"customStartDate",xtype:"rallydatefield",label:"Custom chart Start Date",config:defaultConfig},{name:"customTrendStartDate",xtype:"rallydatefield",label:"Custom Start Date for Trend ",config:defaultConfig},{name:"maxDaysAfterPlannedEnd",xtype:"rallynumberfield",label:"Max days to show after Planned End",config:Ext.merge(Ext.clone(defaultConfig),{minValue:0,maxValue:250})},{name:"customTitle",xtype:"textfield",label:"Custom Chart Title",config:Ext.merge({},defaultConfig,{width:400})},{name:"markAuxDates",xtype:"checkboxfield",label:"This checkbox enables marking custom dates on the chart. Such dates can be specified in the Notes field of the Milestone - e.g. '2017-05-14 Code Freeze', each entry in separate line.",config:checkboxConfig},{name:"smallDisplay",xtype:"checkbox",label:"Adjust chart to small display",config:checkboxConfig}],contextTimebox=this.getContextTimebox();return"milestone"!=getRallyRecordType(contextTimebox)&&settingsFields.unshift({name:"milestone",label:"Milestone (multi-select)",xtype:"mymilestonecombobox"}),settingsFields},config:{defaultSettings:{maxDaysAfterPlannedEnd:40,markAuxDates:!0}},getMilestoneIds:function(){if("milestone"==getRallyRecordType(this.getContextTimebox()))return[this.getContextTimebox()];var milestones=this.getSetting("milestone");return milestones?milestones.split(","):[]},getReleaseId:function(){return"release"==getRallyRecordType(this.getContextTimebox())?this.getContextTimebox():this.getSetting("release")},getProjectId:function(){return this.getContext().getProject().ObjectID},setDataLoading:function(loading){this.setLoading(this.dataLoaded?!1:loading)},setDataLoaded:function(){this.dataLoaded=!0,this.setLoading(!1)},layout:"fit",launch:function(){Ext.define("MyMilestoneComboBox",{extend:"Rally.ui.combobox.MilestoneComboBox",alias:"widget.mymilestonecombobox",editable:!1,config:{multiSelect:!0,allowNoEntry:!0,emptyText:"-- All milestones --",defaultToCurrentItem:!1,hideLabel:!1}}),this.getDataForChart().then({success:function(chartSetup){this.add(Ext.merge(this.createChart(),chartSetup))},failure:function(error){this.setDataLoaded();var lines=["Unable to fetch data."];error&&error.error&&error.error.errors?lines=lines.concat(error.error.errors):lines.push(error),this.add({xtype:"container",html:lines.join("<br/>"),componentCls:"center"})},scope:this})},listeners:{boxready:function(app){app.setDataLoading(!0)},ready:function(app){app.defineCalculator()}},defineCalculator:function(){function metric(label,values){return{as:label,f:"filteredSum",field:"PlanEstimate",filterField:"ScheduleState",filterValues:values,display:"column"}}Ext.define("My.MilestoneBurnUpCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",mixins:["My.BurnUpCalculation"],getMetrics:function(){return[metric("In Progress",["In-Progress"]),metric("Completed",["Completed"]),metric("Accepted",["Accepted","Released"]),{as:"Scope",f:"sum",field:"PlanEstimate",display:"line"}]},runCalculation:function(snapshots,snapshotsToSubtract){var data=this.callParent(arguments);return this.chartConfig=this.calculate(data,this.calculationConfig),data}})},createChart:function(){var app=this;return Ext.create("Rally.ui.chart.Chart",{chartColors:["#B4F4D9","#9FDDA7","#6DBD44",app.scopeColor||"#005EB8","#000","#000"],chartConfig:{title:{text:"Milestone"},chart:{zoomType:"xy"},xAxis:{title:{text:"Date"},labels:{maxStaggerLines:1,step:5}},yAxis:{title:{text:"Points"}},plotOptions:{line:{marker:{enabled:!1},lineWidth:4},column:{pointPadding:0,groupPadding:.15,stacking:!0},area:{stacking:!0,marker:{enabled:!1}}}},listeners:{snapshotsAggregated:function(chart){Ext.merge(chart.chartConfig,chart.calculator.chartConfig)},storesLoaded:function(){app.setLoading(!1)}}})},getDataForChart:function(){return promiseAll([0===this.getMilestoneIds().length?[]:Rally.data.ModelFactory.getModel({type:"Milestone"}).then({success:function(model){return promiseAll(this.getMilestoneIds().map(function(id){return model.load(id)}))},scope:this}),this.getReleaseId()?Rally.data.ModelFactory.getModel({type:"Release"}).then({success:function(model){return model.load(this.getReleaseId())},scope:this}):null]).then({success:function(timeboxes){var milestones=timeboxes[0],release=timeboxes[1];if(!release&&0===milestones.length)return rejectedPromise("No milestone specified. Set milestone or release filter in your page settings or choose milestone in your app settings.");var query=joinNotEmpty([joinNotEmpty(milestones.map(function(milestone){return"(Milestones.ObjectID contains "+milestone.getId()+")"})," OR ","(",")"),release?"(Release.ObjectID = "+release.getId()+")":null]," AND ","(",")"),filter=Rally.data.wsapi.Filter.fromQueryString(query),context={project:this.getProjectId()?"/project/"+this.getProjectId():null};return promiseAll(["PortfolioItem/TeamFeature","HierarchicalRequirement","Defect"].map(function(artifactType){return Ext.create("Rally.data.wsapi.Store",{model:artifactType,filters:filter,fetch:["ObjectID","Milestones","Parent","PortfolioItem"],context:context,autoLoad:!0,limit:1/0}).load()})).then({success:function(results){var artifactIds=[].concat(results[0],results[1],results[2]).map(function(record){return+record.raw.ObjectID});return this.getConfigForChart(artifactIds,milestones,release)},scope:this})},scope:this})},getConfigForChart:function(artifactIds,milestones,release){var storeConfig={listeners:{load:function(store,data,success){}},find:{_ProjectHierarchy:this.projectId,_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},_ItemHierarchy:{$in:artifactIds},Children:null},fetch:["PlanEstimate","ScheduleState","FormattedID"],hydrate:["ScheduleState"],sort:{_ValidFrom:1},limit:1/0,removeUnauthorizedSnapshots:!0,useHttpPost:!0},today=new Date,plannedEndDate=this.getPlannedEndDate(milestones,release),maxDaysAfterPlannedEnd=this.getSetting("maxDaysAfterPlannedEnd"),endDate=plannedEndDate;if(plannedEndDate){if(today>plannedEndDate){var maxEndDate=addBusinessDays(plannedEndDate,maxDaysAfterPlannedEnd);endDate=today>maxEndDate?maxEndDate:today}}else endDate=today;return{calculatorType:"My.MilestoneBurnUpCalculator",calculatorConfig:{endDate:endDate,calculationConfig:{maxEndDate:endDate,plannedEndDate:plannedEndDate,auxDates:this.getAuxDates(milestones,release),customStartDate:this.getSetting("customStartDate"),customProjectionStartDate:this.getSetting("customTrendStartDate"),maxDaysAfterPlannedEnd:maxDaysAfterPlannedEnd,smallDisplay:this.getSetting("smallDisplay")}},storeType:"Rally.data.lookback.SnapshotStore",storeConfig:storeConfig,exceptionHandler:loggingSnapshotStoreExceptionHandler,queryErrorMessage:"No work items found for <strong>"+this.getChartTitle(milestones,release)+"</strong>.",chartConfig:{title:{text:this.getChartTitle(milestones,release),useHTML:!0}}}},getPlannedEndDate:function(milestones,release){var app=this,result=null;return milestones.forEach(function(milestone){var date=milestone.get("TargetDate");(!result||date&&date>result)&&(result=date,app.scopeColor=milestone.get("DisplayColor")||this.scopeColor)}),!result&&release?release.get("ReleaseDate"):result},getAuxDates:function(milestones,release){var result={},app=this;return milestones.forEach(function(milestone){app.getSetting("markAuxDates")&&milestone.get("Notes").split(/<\/?\w+>/g).map(function(html){return html.trim().match(/(\d\d\d\d-\d\d-\d\d)\W+(\w.*)/)}).forEach(function(matches){matches&&!isNaN(Date.parse(matches[1]))&&(result[matches[1]]=matches[2])}),milestone.get("TargetDate")&&(result[dateToIsoString(milestone.get("TargetDate"))]=milestone.get("Name"))}),release&&release.get("ReleaseDate")&&(result[dateToIsoString(release.get("ReleaseDate"))]=release.get("Name")),result},getChartTitle:function(milestones,release){var customTitle=this.getSetting("customTitle");if(customTitle)return customTitle;var context=this.getContext();return joinNotEmpty([release?formatRelease(release,context):null,milestones.map(function(milestone){return formatMilestone(milestone,context)}).join(", ")],": ")}},dev?dev.app:null));

            Rally.launchApp('MilestoneBurnupWithProjection', {
                name:"Milestone Burnup with Projection",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .center{text-align:center}
    </style>
</head>
<body>
</body>
</html>
