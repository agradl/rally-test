<!DOCTYPE html>
<html>
<head>
    <title>RallyTest</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function debug(a1, a2) {
    if (window.debug) {
        console.log(a1, a2);
    }
}

/**
 *
 * @param {Array} data Array of objects returned by Rally Store
 * @param {Array} columns If present, returns values only for specified columns, in the provided order
 * @returns {string} Lines of tab-separated values
 */
function rallyDataToString(data, columns) {
    if (!data || !data[0] || !data[0].raw) {
        return "No data to display: " + data;
    }
    var actualColumns = columns || Object.keys(data[0].raw);
    var keys = actualColumns.map(function (column) {
        return column.split('.');
    });
    return data.reduce(function (result, row) {
        result.push(keys.map(function (key) {
            var value = row.raw[key[0]];
            return "" + value == "[object Object]" && key[1] ? value[key[1]] : value;
        }).join('\t'));
        return result;
    }, [actualColumns.join('\t') + '\t' + data.length]).join('\n');
}

/**
 * @param {Object} permissions Permissions Object. When no specified, permission from current Rally app are taken.
 * @returns {string} String representation of permissions
 */
function rallyPermissionsToString(permissions) {
    return (permissions || Rally.getApp().context.getPermissions().userPermissions).map(function (permission) {
        return permission.Role + '\t' + permission._refObjectName;
    }).join('\n');
}

/**
 * Ext.create('Rally.data.lookback.SnapshotStore', {
 *      exceptionHandler: loggingSnapshotStoreExceptionHandler
 *      ...
 * });
 * @param proxy
 * @param response
 * @param operation
 */
function loggingSnapshotStoreExceptionHandler(proxy, response, operation) {
    var messages = JSON.parse(response.responseText);
    var log = function (message) {
        console.log(message);
    };
    console.log("Problem when obtaining snapshot data:");

    messages.Errors.forEach(log);
    messages.Warnings.forEach(log);

    console.log("proxy =", window.proxy = proxy);
    console.log("response =", window.response = response);
    console.log("operation =", window.operation = operation);
}

/**
 * @param {string} projectName E.g. schedule, profit, slot. Fallback to AVPS as a whole
 * @returns {number} Rally ID of project
 */
function avpsProjectId(projectName) {
    switch ((projectName || "").toLowerCase().replace(/[ -_]*/g, "")) {
        case "codeshare":
            return 52219765529;
        case "fleet":
            return 52953911025;
        case "profit":
        case 'network':
            return 52220062189;
        case "schedule":
            return 52220062990;
        case "schedulekrk":
            return 53630224881;
        case "scheduledfw":
            return 53630226508;
        case "slot":
            return 52219769418;
        case "systems":
            return 52219764059;
        default:
            return 52219602590;
    }
}

/**
 * @returns {number} Sabre Production Workspace ID
 */
function sabreWorkspaceId() {
    return 27154375360;
}
                Ext.define("CustomApp", {
    extend: "Rally.app.App",
    componentCls: "app",

    stateful: true,

    getState: function () {
        var value = this.milestonePicker.getValue();
        this.milestoneId = value ? +value.replace("/milestone/", "") : null;
        state = {
            milestoneId: this.milestoneId
        };
        console.log("current state:", state); // DEBUG
        return state;
    },

    applyState: function (state) {
        if (state) {
            this.milestoneId = state.milestoneId;
            console.log("loading state:", state); // DEBUG
        } else {
            console.log("No state to restore:", state); // DEBUG
        }
    },

    launch: function () {
        function handleMilestoneSelection(app) {
            var value = app.milestonePicker.getValue();
            app.milestoneId = value ? +value.replace("/milestone/", "") : null;
            if (app.milestoneId) {
                console.log("saving state..."); // DEBUG
                app.saveState();
            }
            app.drawChart();
        }

        this.milestonePicker = this.add({
            xtype: 'rallymilestonecombobox',
            cls: 'milestone-for-chart',
            editable: false,
            noEntryText: '-- choose a milestone --',
            allowNoEntry: true,
            listeners: {
                select: function () {
                    handleMilestoneSelection(this);
                },
                ready: function () {
                    if (this.milestoneId) {
                        this.milestonePicker.setValue("/milestone/" + this.milestoneId);
                    }
                    handleMilestoneSelection(this);
                    this.milestonePicker.ready = true;
                },
                scope: this
            }
        });
    },

    burnupCalculator: Ext.define("Sabre.MilestoneBurnUpCalculator", {
        extend: "Rally.data.lookback.calculator.TimeSeriesCalculator",

        getMetrics: function () {
            return [
                {
                    field: "PlanEstimate",
                    as: "In Progress",
                    f: "filteredSum",
                    filterField: "ScheduleState",
                    filterValues: ["In-Progress"],
                    display: "column"
                },
                {
                    field: "PlanEstimate",
                    as: "Completed",
                    f: "filteredSum",
                    filterField: "ScheduleState",
                    filterValues: ["Completed"],
                    display: "column"
                },
                {
                    field: "PlanEstimate",
                    as: "Accepted",
                    f: "filteredSum",
                    filterField: "ScheduleState",
                    filterValues: ["Accepted", "Released"],
                    display: "column"
                },
                {
                    field: "PlanEstimate",
                    as: "Planned",
                    f: "sum",
                    display: "line"
                }
            ];
        }
    }),

    drawChart: function () {
        if (!this.milestoneId) {
            return;
        }
        var storeConfig = {
            listeners: {
                load: function (store, data, success) {
                    debug(rallyDataToString(data, ["_ValidFrom", "_ValidTo", "PlanEstimate", "ScheduleState"]));
                }
            },
            find: {
                //_ProjectHierarchy: avpsProjectId('fleet'),
                _ProjectHierarchy: this.getContext().getProject().ObjectID,
                _TypeHierarchy: {$in: ["Defect", "HierarchicalRequirement"]},
                Milestones: {$in: [this.milestoneId]},
                Children: null
            },
            fetch: ["PlanEstimate", "ScheduleState"],
            hydrate: ["ScheduleState"],
            sort: {_ValidFrom: 1}
        };

        if (this.chart) {
            this.remove(this.chart);
        }
        this.chart = Ext.create("Rally.ui.chart.Chart", {
            calculatorType: "Sabre.MilestoneBurnUpCalculator",
            calculatorConfig: {},

            storeType: "Rally.data.lookback.SnapshotStore",
            storeConfig: storeConfig,

            chartColors: ["#EEE", "#8FCD88", "#5EAC00", "#005EB8"],
            chartConfig: {
                title: { text: ""},
                chart: {zoomType: "xy"},
                xAxis: {title: {text: "Date"}},
                yAxis: {title: {text: "Points"}},
                plotOptions: {
                    line: {
                        marker: {enabled: true}
                    },
                    column: {
                        stacking: true
                    },
                    area: {
                        stacking: true,
                        marker: {enabled: false}
                    }
                }
            }
        });
        this.add(this.chart);
    }
});


            Rally.launchApp('CustomApp', {
                name:"RallyTest",
	            parentRepos:""
            });

        });
    </script>



    <style type="text/css">
        .app {
  /* Add app styles here */
}
.milestone-for-chart {
  margin: 10px auto;
  padding: 10px;
}

    </style>
</head>
<body>
</body>
</html>
